---
layout:     post
title:      ios应用逆向工程1-4章笔记
date:       2017-12-18
summary:    ios应用逆向工程1-4章笔记
categories: 二进制
tags:
 - ios
 - reverse
---

### 概念篇+工具篇

1.bundle的概念来源于NeXTSTEP,它不是一个文件,而是一个按某种标准结构来组织的目录,其中包含了二进制文件及运行所需的资源.正向开发中常见的App和framework都是以bundle的形式存在的;framework也是bundle,但framework的bundle中存放的是一个dylib,而不是可执行文件.相对来说,framework的地位比App更高,因为一个App的绝大多数功能都是通过调用framework提供的接口来实现的.将某个bundle确立为逆向目标后,绝大多数逆向线索都可以在bundle内找到,这大大降低了逆向工程的复杂度

2.Xcode自带的plutil工具可查看plist文件,命令为`plutil -p xxx.plist`

3.ios的app目录中的lproj目录下存放的是各种本地化的字符串(.strings),是ios逆向工程的重要线索,也可以用plutil查看

4.storeapp的数据目录在`/var/mobile/Containers/Data`下,以mobile权限运行的系统app的数据目录在`/var/mobile/`下,而以root权限运行的系统app的数据目录在`/var/root/`下

5.cydia app的安装包格式一般是deb,storeapp的安装包格式一般是ipa,其中deb的属主属组是root:admin,能够以root权限运行,而ipa是苹果为ios推出的专属app安装包格式,属主用户和属组都是mobile,只能以mobile权限运行

6.通俗地说,ios中的沙盒就是一种访问限制机制,我们可以把它看作是权限的一种表现形式,授权文件也是沙盒的一部分.总的来说,沙盒会将app的文件访问范围限制在这个app内部,一个app一般不知道其他app的存在,更别说访问它们了,沙盒还会限制app的功能,例如对icloud接口的调用就必须经过沙盒的允许.越狱本身已经破除了ios的绝大多数安全限制,并对沙盒进行了一定程度的扩充,因此我们往往很容易忽略sandbox的存在,从而碰到一些看似很奇怪的问题.比如某个tweak不能写文件,调用了某个函数却没有出现应有的效果,在确保自己的代码没有问题的前提下,就要回过头来检查这些问题是不是因为权限不够,或者沙盒限制造成的

7.cydia里的各种tweak无一不是以dylib的形式工作的

8.ios实际上存在真正的后台多任务,如接听电话时ios会第一时间将接听电话界面呈现在我们面前.不过,对于storeapp来说,当用户按下home键时,进程就进入后台了,大多数功能都会被暂停

9.在theos新建的工程目录文件夹中,可以创建一个名为`layout`的文件夹,然后把工程打包成deb并安装到ios中,此时`layout`中的所有文件会被解包到ios文件系统的相同位置(这里的`layout`相当于ios中的根目录`/`),这极大扩充了deb包的什么用范围

10.命令行安装theos生成的deb到手机的方法:在makefile的最上一行加上本机ip地址`THEOS_DEVICE_IP=...`,然后调用`make package install`命令完成编译打包安装一条龙服务

11.免ssh输密码
+ 删除本机~/.ssh/known_hosts中目标ip对应条目
+ 在本机生成ida_rsa.pub文件:`ssh-keygen -t rsa`,生成的文件为`~/.ssh/id_rsa.pub`
+ 在目标机器终端中`ssh-keygen`
+ 在本机中执行`scp ~/.ssh/id_rsa.pub user@目标ip:~/.ssh/authorized_keys`
+ 如果希望多台机器ssh到同一目标机器免密码可将多台机器`ssh-keygen -t rsa`生成的id_rsa.pub内容追加到目标机器的authorized_keys文件中

12.reveal的使用
+ cydia中搜索安装reveal loader
+ 在手机的设置中打开要分析的app的enabled applications开关
+ 在macOS中中打开reveal,确保macOS和ios在同一网段内,重启ios中的目标app

13.ida中main windows有两种显示模式,分别是graph view和text view,它们之间可以通过空格键切换.grahp view把被分析的程序逻辑用方块的形式表现出来,当执行遇到分支时,满足判断条件分支的线是绿色的,否则是红色的;当执行没有分支时,线是蓝色的

14.ida中"jump to xref to operand"(快捷键x),点击后出现的窗口罗列了这个文件中显式引用这个符号的所有信息."xref from"则显示这个符号引用的所有符号

15.越狱ios必须安装"apple file conduit2",简称afc2,这样才可以浏览ios全系统文件

16.dyld_decache
+ 从ios3.1开始,包括frameworks在内的许多库文件被存进了一个大cache里,这个cache文件位于"/System/Library/Caches/com.apple.dyld/dyld_shared_cache_armx"(名为dyld_shared_cache_arm7,dyld_shared_cache_armv7s或dyld_shared_cache_arm64),可以使用KennyTM开发的dyld_decache将其中的二进制文件提取出来.这样做的好处是确保分析的文件来自本机
+ 使用dyld_decache之前,要将"System/Library/Caches/com.apple.dyld/dyld_shared_cache_armx"从ios拷贝到macOS,然后再用[这个工具][1]提取二进制文件.arm64如果出错可google:`site:iosre.com dsc_extractor`来解决
+ 可用ios_deploy来从dyld_shared_cache提取ida的符号文件,ida很依赖这些符号文件(有了它们才能快速和准确的反编译),命令如下
    + ios_deploy symbols
    + 详细命令在[这里][2]
    + 中文文档在[这里][3]

17.CydiaSubstrate是绝大部分tweak正常工作的基础,它由MobileHooker,MobileLoader和Safe mode组成
+ MobileHooker的作用是替换系统函数,也就是所谓的hook,它主要包含以下两个函数
    + `void MSHookMessageEx(Class class,SEL selector,IMP replacement,IMP *result);`
> 其中MSHookMessageEx作用于Objective-C函数,通过调用method_setImplementation函数将[class selector]的实现改为replacement,达到hook的目的.Logos语法主要是对此函数作了一层封装,让编写针对Object-C函数的hook代码变得更简单直观了,但其底层实现仍完全基于MSHookMessageEx
    + `void MSHookFunction(void* function,void* replacement,void** p_original);`
> MSHookFunction作用于C和C++函数,通过编写汇编指令,在进程执行到function时转而执行replacement,同时保存function的指令及其返回地址,使得用户可以选择性地执行function,并保证进程能够在执行完replacement后继续正常运行

[1]: https://github.com/kennytm/Miscellaneous/releases
[2]: https://www.hex-rays.com/products/ida/support/tutorials/ios_debugger_tutorial.pdf
[3]: https://bbs.pediy.com/thread-223172-1.htm
