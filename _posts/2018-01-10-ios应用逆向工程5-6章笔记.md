---
layout:     post
title:      ios应用逆向工程5-6章笔记
date:       2018-01-10
summary:    ios应用逆向工程5-6章笔记
categories: 二进制
tags:
 - ios
 - reverse
---

### 理论篇

1.依据维基百科的定义,tweak指的是对电子系统进行轻微调整来增强其功能的工具;在iOS中,tweak特指那些能够增强基他进程功能的dylib,是越狱iOS的最重要组成部分.这种增强原有工具功能的方法是通过`进程注入`实现的,就像书籍的知识注入大脑的,让大脑变得更强

2.一般来说,编写tweak会用到C,C++和Objective-C三种语言

3.iOS是个封闭的系统,它暴露给我们的中是冰山一角,有太多太多的功能还有待我们进一步挖掘.每次越狱发布后,都会有人把最新的头文件发布出来,google一下`iOS private headers`即可轻松找到下载链接,省去了自己class-dump的麻烦

4.定位目标文件
+ 固定位置
    我们的逆向目标一般是dylib,bundle或daemon,它们在系统中的位置几乎是固定的:
    + 基于CydiaSubstrate的dylib全部位于`/Library/MobileSubstrate/DynamicLibraries/`下,几乎不费吹灰之力就可以轻松定位
    + bundle主要分为App和framework两类,其中Appstore App全部位于`/var/mobile/Containers/Bundle/Application`下,系统App全部位于`/Applications`下,framework全部位于`/System/Library/Frameworks`或`/System/Library/PrivateFrameworks`下
    + daemon的配置文件均位于`/System/Library/LaunchDaemons/`,`/Library/LaunchDaemons`或`/Library/LaunchAgents/`下,是一个plist格式的文件.其中的`ProgramArguments`字段,即是daemon可执行文件的绝对路径
+ cydia
    通过`dpkg -i`安装的的deb包,内容会被cydia如实记录,可在cydia中的`Filesystem Content`中找到路径
+ PreferenceBundle
    PreferenceBundle是寄生在Settings应用里的App,它的功能界定有些模糊,既可以作为单纯的配置文件,由别的进程读取后执行,也可以估计有实际功能,自己来执行一些操作.来自AppStore的第三方PreferenceBundle仅可作为配置文件存在,不会含有实际功能;来自Cydia的也不是问题,可通过上面的定位方式找到路径;但对于iOS自带的PreferenceBundle来说,定位的过程就要复杂一些.PreferenceBundle的界面可以用代码编写,也可以用固定格式的plist文件构造.

5.使用`cycript`可快速测试函数功能,比theos方便

6.解析函数参数
+ `getClassName`函数能够把对象的类名表示成一个`char*`,如`object_getClassName(arg1)`获取arg1这个对象的的对象类名
+ `description`函数能够把对象的内容表示成一个NSString,如`[arg1 description]`获取arg1这个对象的对象内容

```
%hook SBScreenFlash
- (void)flashColor:(id)arg1 withCompletion:(id)arg2
{
    %orig;
    NSLog(@"iOSRE: flashColor: %s, %@", object_getClassName(arg1),arg1);//[arg1 description]可以直接写成arg1
}
end
```

上面的示例中打印的结果为`iOSRE: flashColor: UICachedDeviceWhiteColor, UIDeviceWhiteColorSpace 1 1`,其中`UICachedDeviceWhiteColor`是对象类名,`UIDeviceWhiteColorSpace 1 1`是对象内容

7.书籍作者强烈建议大家通览class-dump出的头文件,把那些语义明显,自己感兴趣的函数放到iOS上实测一下,这个过程能极大地增加对iOS底层的熟悉程度

8.ARM处理器中的特殊用途的寄存器
+ R0-R3     传递参数与返回值
+ R7        帧指针,指向母函数与被调用子函数在栈中的交界(相当于ebp?)
+ R9        在ios3.0以前被系统保留
+ R12       内部过程调用寄存器,dynamic linker会用到它
+ R13       SP寄存器(相当于esp?)
+ R14       LR寄存器,保存函数返回地址(居然有一个单独的寄存器用来保存函数返回地址)
+ R15       PC寄存器(相当于eip?)

9.ARM处理器用到的指令集分为ARM和THUMB两种;ARM指令长度均为32bit,THUMB指令长度均为16bit.THUMB指令比ARM指令更节省空间,且在16位数据总线上的传输效率更高,相对于ARM指令,THUMB指令的缺点如下
+ 指令数量减少
+ 没有条件执行
+ 所有指令默认附带"s"
+ 桶式移位无法结合其他指令执行
+ 寄存器使用受限
+ 立即数和第二操作数使用受限
+ 不支持数据写回
