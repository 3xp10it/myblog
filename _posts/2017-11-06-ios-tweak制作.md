---
layout:     post
title:      ios tweakåˆ¶ä½œ
date:       2017-11-06
summary:    ios tweakåˆ¶ä½œ
categories: äºŒè¿›åˆ¶
tags:
 - ios
 - tweak
 - lldb
---

### 0x00 å·¥å…·å‡†å¤‡

1.tweakåˆ¶ä½œå·¥å…·(æ¡†æ¶):[theos][1]

2.ios appè„±appstoreåŠ çš„å£³å·¥å…·:[clutch][2],å¦‚æœå¤±è´¥åˆ™ç”¨[dumpdecrypted][7]å°è¯•

3.ios appå¤´æ–‡ä»¶æå–å·¥å…·:[class-dump][3]

4.class-dumpçš„swift+object cä¸æŠ¥é”™ç‰ˆæœ¬:[é¡¹ç›®åœ°å€][4],[å¯æ‰§è¡Œæ–‡ä»¶][5]

5.æŸ¥çœ‹è¿è¡Œæ—¶å‡½æ•°è°ƒç”¨åŠè°ƒç”¨å‚æ•°å€¼å·¥å…·:logify.pl,logifyæ˜¯theosçš„ä¸€ä¸ªå†…ç½®å·¥å…·,è·¯å¾„ä¸º/opt/theos/bin/logify.pl

6.è¿œç¨‹è°ƒè¯•ioså·¥å…·:debugserver+lldb+[ida pro]

7.æŸ¥çœ‹ios appä¸­çš„uiå¯¹åº”çš„ç±»çš„å·¥å…·(å®‰è£…åœ¨æ‰‹æœºä¸Š):[flex_injected][6]

### 0x01 tweakåˆ¶ä½œå®ä¾‹

#### å®ç°ä¸€ä¸ªappä¸Šä¼ æ­¥æ•°å¤§äº5000

```
ssh root@iphone.ip
wget https://github.com/KJCracks/Clutch/releases/download/2.0.4/Clutch-2.0.4 -O /usr/bin/Cluth
Cluth -i
Cluth -d index_number_of_target_app
scp output.ipa user@pc_ip:
exit
unzip output.ipa -d ~/output
class-dump -H ~/output/Payload/xxx.app/xxx -o ~/output_header
åˆ†æå‡ºå¯ç–‘ç±»ä¸­çš„å‡½æ•°ä¸ºPARSPedometerInfo.hä¸­çš„å‡½æ•°[ç»“åˆflex_injected,ida pro,frida,logify.plå¾—å‡º]
nic.pl
é€‰æ‹©æ–°å»ºä¸€ä¸ªiphone tweak,é¡¹ç›®ç›®å½•ä¸º~/xupload
è®¾ç½®MobileSubstrate Bundle filterçš„å€¼ä¸ºoutput.ipaçš„bundleidçš„å€¼,å¯ä»output.ipaçš„info.plistä¸­å¾—åˆ°
logify.pl ~/output_header/PARSPedometerInfo.h > ~/xupload/Tweak.xm[è¿™ä¸€æ­¥æ˜¯ä¸ºäº†hookå¯ç–‘å‡½æ•°,æŸ¥çœ‹è°ƒç”¨åŠå‚æ•°]
cd xupload
make
make package
scp package/xxxx.deb root@iphone.ip:
ssh root@iphone.ip
dpkg -i xxxx.deb
æ‰‹æœºè¿æ¥mac,æ‰“å¼€xcode,åœ¨windows|device and simulators|ç‚¹å‡»æŸ¥çœ‹logæŒ‰é’®(å°ä¸‰è§’å½¢çŠ¶)
è¿è¡Œç›®æ ‡appå¹¶ç‚¹å‡»ä¸Šä¼ æ­¥æ•°
æŸ¥çœ‹xcodeä¸­å‡½æ•°çš„è°ƒç”¨æ—¥å¿—å¦‚ä¸‹
```

```
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:20[m [0;30;46mDEBUG:[m  = PARSPedometerInfo<0x1708d8f70>: 
	 integration=0 
	 iPhone=0 
	 watch=0 
	 heartRat=0
	 at:2017-11-05 16:00:00 +0000
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:21[m [0;30;46mDEBUG:[m  = PARSPedometerInfo<0x1708d8f70>: 
	 integration=0 
	 iPhone=0 
	 watch=0 
	 heartRat=0
	 at:2017-11-05 16:00:00 +0000
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:12[m [0;30;46mDEBUG:[m -[<PARSPedometerInfo: 0x1708d8f70> setIntegratedSteps:36]
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:8[m [0;30;46mDEBUG:[m -[<PARSPedometerInfo: 0x1708d8f70> setStartDate:2017-11-04 16:00:00 +0000]
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:21[m [0;30;46mDEBUG:[m -[<PARSPedometerInfo: 0x174ad8100> init]
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:20[m [0;30;46mDEBUG:[m -[<PARSPedometerInfo: 0x174ad8100> description]
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:20[m [0;30;46mDEBUG:[m  = PARSPedometerInfo<0x174ad8100>: 
	 integration=0 
	 iPhone=0 
	 watch=0 
	 heartRat=0
	 at:2017-11-05 16:00:00 +0000
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:21[m [0;30;46mDEBUG:[m  = PARSPedometerInfo<0x174ad8100>: 
	 integration=0 
	 iPhone=0 
	 watch=0 
	 heartRat=0
	 at:2017-11-05 16:00:00 +0000
Nov  6 12:05:32 iPhone PALifeApp[4494] <Notice>: [1;36m[xupload] [m[0;36mTweak.xm:12[m [0;30;46mDEBUG:[m -[<PARSPedometerInfo: 0x174ad8100> setIntegratedSteps:2305]
```

ä»ä¸Šé¢æ—¥å¿—ä¸­å‘ç°å…³é”®å‡½æ•°åŠå‚æ•°setIntegratedSteps:2305,äºæ˜¯è¦hookè¿™ä¸ªå‡½æ•°å¹¶è®¾ç½®å‚æ•°ä¸ºå¤§äº5000çš„å€¼.
å›åˆ°Tweak.xmä¸­æŸ¥çœ‹è¿™ä¸ªå‡½æ•°

```
- (void)setIntegratedSteps:(long long )integratedSteps { %log; %orig; }
```

ä»ä¸­çœ‹å‡ºsetIntergratedStepså‡½æ•°ä¼ å…¥äº†ä¸€ä¸ªå‚æ•°,å‚æ•°ç±»å‹æ˜¯long long,è¿™ä¹Ÿæ˜¯ä¸€ç§intç±»å‹,å¤§å°èŒƒå›´æ˜¯intç±»å‹çš„4å€,ç›´æ¥ä¿®æ”¹
æˆ

```
%hook PARSPedometerInfo
- (void)setIntegratedSteps:(long long )integratedSteps { %log; %orig(15347);  }
%end
```

```
make clean
make 
make package
scp packages/xxx.deb root@iphone.ip:
ssh root@iphone.ip
dpkg -P com.yourcompany.xupload
dpkg -i xxx.deb
```

é‡æ–°è¿è¡Œç›®æ ‡appå¹¶ç‚¹å‡»ä¸Šä¼ æ­¥æ•°,æˆåŠŸä¸Šä¼ ,åæ¥åˆ†æä¸Šé¢setIntegratedStepså‡½æ•°è°ƒç”¨çš„å‚æ•°ä¸ºintegratedStepså‡½æ•°,ä¹Ÿå³
integratedStepså‚æ•°çš„è¿”å›å€¼ä½œä¸ºsetIntegratedStepså‡½æ•°çš„å‚æ•°,ä¹Ÿå³åŒæ ·å¯é€šè¿‡hook integratedStepså‡½æ•°æ¥å®ç°,åˆ†æè®¤ä¸º
integratedStepså‡½æ•°æ˜¯è·å–æœ¬åœ°çš„æ­¥æ•°å€¼,è€ŒsetIntegratedStepså‡½æ•°æ˜¯ä¸Šä¼ æœ¬åœ°æ­¥æ•°.hook integratedStepså‡½æ•°å¯å¦‚ä¸‹ä¿®æ”¹
```
å°†
- (long long )integratedSteps { %log; long long  r = %orig; HBLogDebug(@" = %lld", r); return r; }
ä¿®æ”¹ä¸º:
- (long long )integratedSteps { %log; long long  r =15347; return r; }
```

### 0x02 æ³¨æ„äº‹é¡¹ 

1.åœ¨è¿è¡Œnic.plæ–°å»ºtweaké¡¹ç›®æ—¶åœ¨è¾“å…¥bundleidæ—¶é»˜è®¤å€¼ä¸ºcom.apple.springboard,è¿™é‡Œè¦ä¿®æ”¹,ä¸”è¦ä¿®æ”¹æˆè¦hookçš„appçš„
bundleid,æŸ¥çœ‹bundleidå¯åœ¨appçš„å®‰è£…åŒ…çš„Info.plistæ–‡ä»¶ä¸­å¾—åˆ°

2.hookåŸç†ç†è§£

    http://blog.l4ys.tw/2017/06/tmctf-2017-rev400/
    https://www.oschina.net/question/565065_68287

3.å¦‚æœä½¿ç”¨ida proåŠ¨æ€è°ƒè¯•ios app,éœ€è¦è®¾ç½®ä½¿ç”¨è¿œç¨‹gdb server(ä½¿ç”¨ios debugseverå¤±è´¥),åœ¨macä¸Šç”¨idaåŠ è½½è„±å£³åçš„
mach-oæ–‡ä»¶[åœ¨iphoneä¸Šè¿è¡Œçš„æ˜¯æœªè„±å£³çš„app,è¿è¡Œè„±å£³åçš„é‡æ–°å®‰è£…çš„appåº”è¯¥ä¹Ÿå¯ä»¥,æœªå°è¯•],éœ€è¦åœ¨idaä¸­é‡æ–°è®¾ç½®åŠ è½½åŸºå€,
åœ¨idaèœå•çš„edit|segment|rebase programå¤„è®¾ç½®,å¦‚æœä¸è®¾ç½®åŠ è½½åŸºå€ä¼šå¯¼è‡´æ— æ³•ä¸‹æ–­ç‚¹,å› ä¸ºæ–­ç‚¹æ˜¯åœ¨çœŸå®çš„å†…å­˜åç§»å¤„ä¸­æ–­,
è€Œä¸è®¾ç½®åŠ è½½åŸºå€çœ‹åˆ°çš„idaä¸­çš„åç§»åªæ˜¯ç›¸å¯¹åç§»,ç›¸å¯¹åç§»ä¸æ˜¯çœŸå®çš„å†…å­˜åœ°å€,çœŸå®çš„å†…å­˜åœ°å€=åŠ è½½åŸºå€+ç›¸å¯¹åç§».ç›®å‰æš‚
æœªæ‰¾åˆ°å¥½ç”¨çš„æŸ¥çœ‹appè¿è¡Œçš„åŠ è½½åŸºå€çš„æ–¹æ³•,ç½‘ä¸Šæœ‰ç¯‡æ–‡ç« ä½¿ç”¨çš„æ˜¯vmmapæŸ¥çœ‹,å®é™…ç¼–è¯‘æ²¡æˆåŠŸ.

4.åŠ¨æ€è°ƒè¯•æœ€å¥½ç”¨lldbè°ƒè¯•,idaè°ƒè¯•å¾ˆæ…¢,åœ¨lldbä¸­è°ƒè¯•ä¸‹æ–­ç‚¹æ—¶,æ–­ç‚¹åœ°å€å¯æ ¹æ®image list -o -få¾—åˆ°çš„åŠ è½½åŸºå€åŠ ä¸Šida pro
ä¸­æŸ¥çœ‹åˆ°çš„ç›¸å¯¹åç§»å¾—åˆ°

### 0x03 Refer

1.idaè¿œç¨‹è°ƒè¯•iosç¨‹åº

    a.debugserver
        http://blog.csdn.net/u013538542/article/details/72853521
        http://bbs.iosre.com/t/debugserver-lldb-gdb/65
    b.ioså®‰è£…gcc,ldid,make
        http://kimi.it/517.html
    c.è°ƒè¯•
        1)http://blog.csdn.net/proteas/article/details/78083512
        2)https://www.hex-rays.com/products/ida/support/tutorials/ios_debugger_tutorial.pdf

2.iosè¶Šç‹±åº”ç”¨å¼€å‘

    http://www.jianshu.com/p/bc63492e4847
    http://www.swiftyper.com/2016/01/25/ios-tweak-install-guide/

    lldbä¸gdbå‘½ä»¤å¯¹ç…§:
        http://lldb.llvm.org/lldb-gdb.html

    iosè„±appstreçš„å£³:Clutchä¸dumpdecryptedçš„ä½¿ç”¨ 
        http://sunhongyi.com/2017/01/05/iOSReverse-decrytion-tools/
        clutchç”¨æ³•:
            http://www.jianshu.com/p/47836c78eb0a

    makeå‡ºé”™æ—¶å°è¯•è¿™æ ·:
        http://bbs.iosre.com/t/theos/2049

    å®ä¾‹å¼€å‘:
        https://github.com/jackrex/FakeWeChatLoc
        http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653577384&amp;idx=1&amp;sn=b44a9c9651bf09c5bea7e0337031c53c&amp;scene=0#wechat_redirect
        logify.plæ–¹æ³•åŠ æ—¥å¿—
        http://www.qingpingshan.com/m/view.php?aid=156771
    
    å…è¶Šç‹±tweakå¼€å‘
        https://juejin.im/entry/58931dd5128fe10065441717

    åŠ¨æ€è°ƒè¯•(åœ¨idaä¸­è¦è®¾ç½®åŸºå€)
        http://www.cnblogs.com/ludashi/p/5730338.html

    hookåŸç†
        hookç†è§£:
            http://blog.l4ys.tw/2017/06/tmctf-2017-rev400/
            https://www.oschina.net/question/565065_68287

        hookç§ç±»
            https://bbs.kafan.cn/thread-471551-1-1.html
            http://www.epubit.com.cn/book/onlinechapter/33620
        inline hookåŸç†
            http://www.cnblogs.com/zhangdongsheng/archive/2013/04/08/3007154.html
        ç™¾ç§‘
            http://www.baike.com/wiki/API+HOOK
        got hook
            http://ele7enxxh.com/Android-Arm-Inline-Hook.html

        http://gslab.qq.com/article-164-1.html
        http://www.jianshu.com/p/4f6d20076922



[1]: https://github.com/theos/theos
[2]: https://github.com/theos/theos
[3]: https://github.com/nygard/class-dump
[4]: https://github.com/BlueCocoa/class-dump
[5]: https://github.com/3xp10it/mytools/blob/master/class-dump
[6]: https://github.com/dtrukr/FLEX_injected
[7]: https://github.com/stefanesser/dumpdecrypted 
